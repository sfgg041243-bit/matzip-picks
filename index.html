<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ë§›ì§‘ ì¶”ì²œ - Matzip Picks</title>
  <style>
    :root{
      --bg:#0b0f19; --card:#121a2a; --muted:#94a3b8; --text:#e5e7eb;
      --accent:#60a5fa; --accent2:#34d399; --warn:#fbbf24; --danger:#fb7185;
      --line:#22314f; --chip:#0f172a;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;
      background:linear-gradient(180deg,#070a12, #0b0f19); color:var(--text);}
    header{position:sticky; top:0; backdrop-filter: blur(10px);
      background:rgba(11,15,25,.74); border-bottom:1px solid rgba(34,49,79,.6); z-index:10;}
    .wrap{max-width:1120px; margin:0 auto; padding:18px 16px;}
    .top{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;}
    h1{font-size:20px; margin:0; letter-spacing:.2px}
    .pill{font-size:12px; color:var(--muted); border:1px solid rgba(34,49,79,.9);
      padding:6px 10px; border-radius:999px; background:rgba(15,23,42,.35)}
    .controls{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px}
    input, select, button, textarea{
      background:rgba(18,26,42,.95); color:var(--text);
      border:1px solid rgba(34,49,79,.9); border-radius:12px;
      padding:10px 12px; font-size:14px; outline:none;
    }
    textarea{min-height:84px; resize:vertical}
    input{min-width:260px}
    button{cursor:pointer}
    button.primary{border-color:rgba(96,165,250,.7)}
    button.good{border-color:rgba(52,211,153,.7)}
    button.warn{border-color:rgba(251,191,36,.7)}
    button.danger{border-color:rgba(251,113,133,.7)}
    button.ghost{background:transparent}
    button:disabled{opacity:.55; cursor:not-allowed}
    .tabs{display:flex; gap:8px; flex-wrap:wrap; margin-top:12px}
    .tab{padding:8px 10px; border-radius:999px; background:rgba(15,23,42,.25)}
    .tab.on{border-color:rgba(96,165,250,.8); background:rgba(96,165,250,.12)}
    main{padding:22px 0 60px}
    .grid{display:grid; grid-template-columns:repeat(3,1fr); gap:12px}
    @media (max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:560px){.grid{grid-template-columns:1fr} input{min-width:0; flex:1}}
    .card{
      background:rgba(18,26,42,.92);
      border:1px solid rgba(34,49,79,.9);
      border-radius:18px;
      padding:14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      transition:transform .12s ease, border-color .12s ease;
    }
    .card:hover{transform:translateY(-2px); border-color:rgba(96,165,250,.65)}
    .row{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .name{font-weight:800; font-size:16px; margin:2px 0 6px}
    .meta{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .tag{font-size:12px; color:var(--muted); border:1px solid rgba(34,49,79,.9);
      padding:4px 8px; border-radius:999px; background:rgba(15,23,42,.25)}
    .tag.km{color:#c7d2fe}
    .score{font-weight:800}
    .score small{font-weight:600; color:var(--muted)}
    .desc{color:var(--muted); font-size:13px; line-height:1.45; margin:10px 0 12px; min-height:38px}
    .btns{display:flex; gap:8px; flex-wrap:wrap}
    .fav{border-color:rgba(52,211,153,.7)}
    .fav.on{background:rgba(52,211,153,.12)}
    .empty{color:var(--muted); padding:20px 4px}
    .hint{color:var(--muted); font-size:12px; margin-top:10px}
    .rightTools{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}

    /* Modal */
    .backdrop{position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; padding:16px}
    .backdrop.show{display:flex}
    .modal{
      width:min(820px,100%); background:rgba(18,26,42,.98);
      border:1px solid rgba(34,49,79,.9); border-radius:18px; padding:16px;
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
    }
    .modal h2{margin:0 0 8px; font-size:18px}
    .modal .close{float:right}
    .kvs{display:grid; grid-template-columns:140px 1fr; gap:10px; margin-top:12px}
    .kvs div{padding:10px 12px; border:1px solid rgba(34,49,79,.9); border-radius:14px; color:var(--muted); background:rgba(15,23,42,.2)}
    .kvs b{color:var(--text)}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width:760px){.grid2{grid-template-columns:1fr}}
    .formRow{display:flex; flex-direction:column; gap:6px}
    .formRow label{font-size:12px; color:var(--muted)}
    .split{display:flex; gap:10px; flex-wrap:wrap}
    .split > *{flex:1}
    .hr{height:1px; background:rgba(34,49,79,.75); margin:14px 0}
    .small{font-size:12px; color:var(--muted)}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="top">
      <div style="display:flex; align-items:center; gap:10px;">
        <h1>ğŸœ Matzip Picks</h1>
        <span class="pill">í’€ì„¸íŠ¸ MVP Â· no backend (ì„œë²„ ì—†ì´) Â· good vibes(ê°ì„±)ë¡œ ã„±ã„±</span>
      </div>
      <div class="rightTools">
        <span class="pill" id="countPill">0 places</span>
        <span class="pill" id="locPill">ğŸ“ ìœ„ì¹˜: ë¯¸ì‚¬ìš©</span>
      </div>
    </div>

    <div class="tabs">
      <button class="tab on" id="tabAll">ì „ì²´</button>
      <button class="tab" id="tabReco">ì¶”ì²œ</button>
      <button class="tab" id="tabFav">ì¦ê²¨ì°¾ê¸°</button>
      <button class="tab" id="tabRecent">ìµœê·¼ ë³¸</button>
    </div>

    <div class="controls">
      <input id="q" placeholder="ê²€ìƒ‰: ìƒí˜¸/íƒœê·¸/ì£¼ì†Œ (ì˜ˆ: ì„±ìˆ˜, íŒŒìŠ¤íƒ€, í˜¼ë°¥)"/>
      <select id="cat">
        <option value="all">ì¹´í…Œê³ ë¦¬: ì „ì²´</option>
        <option value="í•œì‹">í•œì‹</option>
        <option value="ì¼ì‹">ì¼ì‹</option>
        <option value="ì¤‘ì‹">ì¤‘ì‹</option>
        <option value="ì–‘ì‹">ì–‘ì‹</option>
        <option value="ì¹´í˜">ì¹´í˜</option>
        <option value="ìˆ ì§‘">ìˆ ì§‘</option>
        <option value="ê¸°íƒ€">ê¸°íƒ€</option>
      </select>
      <select id="sort">
        <option value="reco">ì •ë ¬: ì¶”ì²œìˆœ</option>
        <option value="score">ì •ë ¬: í‰ì ìˆœ</option>
        <option value="near">ì •ë ¬: ê°€ê¹Œìš´ìˆœ</option>
        <option value="new">ì •ë ¬: ìµœì‹ ì¶”ê°€</option>
        <option value="name">ì •ë ¬: ì´ë¦„ìˆœ</option>
      </select>

      <button class="good" id="useLoc">ğŸ“ ë‚´ ìœ„ì¹˜ ì‚¬ìš©</button>
      <button class="primary" id="addPlace">+ ë§›ì§‘ ì¶”ê°€</button>
      <button class="ghost" id="addDemo">+ ë°ëª¨ 3ê°œ ì¶”ê°€</button>
      <button class="ghost" id="reset">ë¦¬ì…‹</button>
    </div>

    <div class="controls" style="margin-top:10px">
      <button class="ghost" id="exportBtn">ë°ì´í„° ë‚´ë³´ë‚´ê¸°(JSON)</button>
      <button class="ghost" id="importBtn">ë°ì´í„° ê°€ì ¸ì˜¤ê¸°(JSON)</button>
      <input id="importFile" type="file" accept="application/json" style="display:none">
      <span class="pill">íŒ: lat/lng ìˆìœ¼ë©´ ê±°ë¦¬/ê°€ê¹Œìš´ìˆœ â€œì§„ì§œë¡œâ€ ë¨</span>
    </div>

    <div class="hint">
      âœ… ì €ì¥/ì¶”ì²œ/ìµœê·¼ë³¸ì€ ë¸Œë¼ìš°ì €ì— ì €ì¥ë¨(localStorage).  
      âš ï¸ íšŒì‚¬ PCì—ì„œ ì‹œí¬ë¦¿ ëª¨ë“œë©´ ì €ì¥ì´ ë‚ ì•„ê°ˆ ìˆ˜ ìˆë‹¤ ì•„ì´ê°€(=ê·¸ëŸ´ ìˆ˜ ìˆìŒ).
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid" id="grid"></div>
  <div class="empty" id="empty" style="display:none;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ë°ì´(=ì—†ìŒ). í‚¤ì›Œë“œë‚˜ í•„í„°ë¥¼ ë°”ê¿”ë³´ì´ì†Œ.</div>
</main>

<!-- Detail Modal -->
<div class="backdrop" id="detailBackdrop" role="dialog" aria-modal="true">
  <div class="modal">
    <button class="close ghost" id="closeDetail">ë‹«ê¸°</button>
    <h2 id="mTitle">-</h2>
    <div class="meta" id="mMeta"></div>
    <p class="desc" id="mDesc"></p>

    <div class="kvs">
      <div><b>ì£¼ì†Œ</b><br><span id="mAddr">-</span></div>
      <div><b>ì¶”ì²œ ë©”ë‰´</b><br><span id="mMenu">-</span></div>
      <div><b>ê°€ê²©ëŒ€</b><br><span id="mPrice">-</span></div>
      <div><b>ì˜ì—…</b><br><span id="mHours">-</span></div>
    </div>

    <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap">
      <button class="ghost" id="mapKakao">ì¹´ì¹´ì˜¤ ì§€ë„</button>
      <button class="ghost" id="mapNaver">ë„¤ì´ë²„ ì§€ë„</button>
      <button class="ghost" id="mapGoogle">êµ¬ê¸€ ì§€ë„</button>
      <button class="ghost" id="copy">ì •ë³´ ë³µì‚¬</button>
      <button class="warn" id="edit">ìˆ˜ì •</button>
      <button class="danger" id="del">ì‚­ì œ</button>
    </div>

    <div class="small" style="margin-top:10px">
      ìµœê·¼ ë³¸ ê¸°ë¡/ì¶”ì²œ ì ìˆ˜ëŠ” ìë™ ë°˜ì˜ë¨. (ìš”ê²Œ ì€ê·¼ â€œì„œë¹„ìŠ¤ ë§›â€ ë‚˜ê²Œ í•¨)
    </div>
  </div>
</div>

<!-- Add/Edit Modal -->
<div class="backdrop" id="formBackdrop" role="dialog" aria-modal="true">
  <div class="modal">
    <button class="close ghost" id="closeForm">ë‹«ê¸°</button>
    <h2 id="fTitle">ë§›ì§‘ ì¶”ê°€</h2>
    <div class="small">lat/lng(ìœ„ë„/ê²½ë„)ê¹Œì§€ ë„£ìœ¼ë©´ ê±°ë¦¬ ì •ë ¬ì´ ì°ìœ¼ë¡œ ë¨. ì—†ìœ¼ë©´ ì§€ë„ ê²€ìƒ‰ ë§í¬ë¡œ ì»¤ë²„ ê°€ëŠ¥.</div>

    <div class="hr"></div>

    <div class="grid2">
      <div class="formRow">
        <label>ê°€ê²Œëª… *</label>
        <input id="fName" placeholder="ì˜ˆ: ì—°ë‚¨ íŒŒìŠ¤íƒ€ ë°”" />
      </div>
      <div class="formRow">
        <label>ì¹´í…Œê³ ë¦¬ *</label>
        <select id="fCat">
          <option value="í•œì‹">í•œì‹</option>
          <option value="ì¼ì‹">ì¼ì‹</option>
          <option value="ì¤‘ì‹">ì¤‘ì‹</option>
          <option value="ì–‘ì‹">ì–‘ì‹</option>
          <option value="ì¹´í˜">ì¹´í˜</option>
          <option value="ìˆ ì§‘">ìˆ ì§‘</option>
          <option value="ê¸°íƒ€">ê¸°íƒ€</option>
        </select>
      </div>

      <div class="formRow">
        <label>íƒœê·¸ (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
        <input id="fTags" placeholder="ì˜ˆ: ì„±ìˆ˜, í˜¼ë°¥, êµ­ë°¥" />
      </div>
      <div class="formRow">
        <label>í‰ì  (0~5)</label>
        <input id="fScore" type="number" min="0" max="5" step="0.1" placeholder="ì˜ˆ: 4.7" />
      </div>

      <div class="formRow">
        <label>ì£¼ì†Œ</label>
        <input id="fAddr" placeholder="ì˜ˆ: ì„œìš¸ ì„±ë™êµ¬ ..." />
      </div>
      <div class="formRow">
        <label>ì¶”ì²œ ë©”ë‰´</label>
        <input id="fMenu" placeholder="ì˜ˆ: ëˆì½”ì¸  ë¼ë©˜, ì°¨ìŠˆë®ë°¥" />
      </div>

      <div class="formRow">
        <label>ê°€ê²©ëŒ€</label>
        <input id="fPrice" placeholder="ì˜ˆ: â‚©â‚© (1~2ë§Œì›)" />
      </div>
      <div class="formRow">
        <label>ì˜ì—…ì‹œê°„</label>
        <input id="fHours" placeholder="ì˜ˆ: 11:00-21:00" />
      </div>

      <div class="formRow">
        <label>ì„¤ëª…(í•œì¤„/ë©”ëª¨)</label>
        <textarea id="fDesc" placeholder="ì˜ˆ: ë¶„ìœ„ê¸° good vibes(ê°ì„± ì¢‹ìŒ). ì¬ë°©ë¬¸ ì˜ì‚¬ 100%"></textarea>
      </div>
      <div class="formRow">
        <label>lat / lng (ì„ íƒ)</label>
        <div class="split">
          <input id="fLat" type="number" step="0.000001" placeholder="ìœ„ë„(lat) ì˜ˆ: 37.5665" />
          <input id="fLng" type="number" step="0.000001" placeholder="ê²½ë„(lng) ì˜ˆ: 126.9780" />
        </div>
        <div class="small">lat/lngëŠ” êµ¬ê¸€ ì§€ë„ì—ì„œ ìœ„ì¹˜ ìš°í´ë¦­ â†’ ì¢Œí‘œ ë³µì‚¬í•˜ë©´ ë¨.</div>
      </div>
    </div>

    <div class="hr"></div>

    <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end">
      <button class="ghost" id="fCancel">ì·¨ì†Œ</button>
      <button class="primary" id="fSave">ì €ì¥</button>
    </div>
  </div>
</div>

<script>
/* ============================
   Matzip Picks - Full MVP
   ============================ */

const LS_PLACES = "matzip_places_v2";
const LS_FAVS   = "matzip_favs_v2";
const LS_RECENT = "matzip_recent_v2";
const LS_LOC    = "matzip_my_loc_v1";

const seed = [
  {
    id:"s1",
    name:"ì„±ìˆ˜ êµ­ë°¥ì§‘",
    cat:"í•œì‹",
    tags:["ì„±ìˆ˜","í˜¼ë°¥","êµ­ë°¥"],
    score:4.6,
    desc:"í‡´ê·¼í•˜ê³  í•œ ê·¸ë¦‡ ë•Œë¦¬ê¸° ë”± ì¢‹ë‹¤ ì•„ì´ê°€(=ì¢‹ìŒ). êµ­ë¬¼ ê¹”ë”, íšŒì „ ë¹ ë¦„.",
    addr:"ì„œìš¸ ì„±ë™êµ¬ ì–´ë”˜ê°€ 123",
    menu:"ë¼ì§€êµ­ë°¥, ìˆ˜ìœ¡",
    price:"â‚©â‚© (1~2ë§Œì›)",
    hours:"11:00-21:00",
    lat:null, lng:null,
    addedAt: Date.now()- 1000*60*60*24*7
  },
  {
    id:"s2",
    name:"ì—°ë‚¨ íŒŒìŠ¤íƒ€ ë°”",
    cat:"ì–‘ì‹",
    tags:["ì—°ë‚¨","ë°ì´íŠ¸","íŒŒìŠ¤íƒ€"],
    score:4.4,
    desc:"ë¶„ìœ„ê¸° good vibes(ê°ì„± ì¢‹ìŒ). ë©´ ìµí˜ ì•ˆì •ì , ì™€ì¸ë„ ìˆìŒ.",
    addr:"ì„œìš¸ ë§ˆí¬êµ¬ ì–´ë”˜ê°€ 45",
    menu:"í¬ë¦¼íŒŒìŠ¤íƒ€, ë¼êµ¬",
    price:"â‚©â‚©â‚© (2~3ë§Œì›)",
    hours:"12:00-22:00",
    lat:null, lng:null,
    addedAt: Date.now()- 1000*60*60*24*4
  },
  {
    id:"s3",
    name:"ì„ì§€ë¡œ ë¼ë©˜",
    cat:"ì¼ì‹",
    tags:["ì„ì§€ë¡œ","ë¼ë©˜","ì›¨ì´íŒ…"],
    score:4.7,
    desc:"ì§„í•œ ëˆì½”ì¸ . ì›¨ì´íŒ… ìˆì„ ìˆ˜ ìˆìœ¼ë‹ˆ íƒ€ì´ë° ì˜ ë´ë¼ì‰(=ì˜í•´).",
    addr:"ì„œìš¸ ì¤‘êµ¬ ì–´ë”˜ê°€ 9",
    menu:"ëˆì½”ì¸  ë¼ë©˜, ì°¨ìŠˆë®ë°¥",
    price:"â‚©â‚© (1~2ë§Œì›)",
    hours:"11:30-20:30",
    lat:null, lng:null,
    addedAt: Date.now()- 1000*60*60*24*2
  }
];

// --- State
let places = loadPlaces();             // array
let favs   = loadSet(LS_FAVS);         // Set
let recent = loadArray(LS_RECENT);     // array of ids
let myLoc  = loadJSON(LS_LOC, null);   // {lat,lng,ts} or null

let activeTab = "all"; // all | reco | fav | recent
let selectedId = null;
let editingId  = null;

// --- Elements
const grid = document.getElementById("grid");
const empty = document.getElementById("empty");
const countPill = document.getElementById("countPill");
const locPill = document.getElementById("locPill");

const q = document.getElementById("q");
const cat = document.getElementById("cat");
const sort = document.getElementById("sort");

const useLoc = document.getElementById("useLoc");
const addPlace = document.getElementById("addPlace");
const addDemo = document.getElementById("addDemo");
const reset = document.getElementById("reset");

const exportBtn = document.getElementById("exportBtn");
const importBtn = document.getElementById("importBtn");
const importFile = document.getElementById("importFile");

// Tabs
const tabAll = document.getElementById("tabAll");
const tabReco = document.getElementById("tabReco");
const tabFav = document.getElementById("tabFav");
const tabRecent = document.getElementById("tabRecent");

// Detail modal
const detailBackdrop = document.getElementById("detailBackdrop");
const closeDetail = document.getElementById("closeDetail");
const mTitle = document.getElementById("mTitle");
const mMeta  = document.getElementById("mMeta");
const mDesc  = document.getElementById("mDesc");
const mAddr  = document.getElementById("mAddr");
const mMenu  = document.getElementById("mMenu");
const mPrice = document.getElementById("mPrice");
const mHours = document.getElementById("mHours");
const mapKakao = document.getElementById("mapKakao");
const mapNaver = document.getElementById("mapNaver");
const mapGoogle = document.getElementById("mapGoogle");
const copyBtn = document.getElementById("copy");
const editBtn = document.getElementById("edit");
const delBtn  = document.getElementById("del");

// Form modal
const formBackdrop = document.getElementById("formBackdrop");
const closeForm = document.getElementById("closeForm");
const fTitle = document.getElementById("fTitle");
const fName  = document.getElementById("fName");
const fCat   = document.getElementById("fCat");
const fTags  = document.getElementById("fTags");
const fScore = document.getElementById("fScore");
const fAddr  = document.getElementById("fAddr");
const fMenu  = document.getElementById("fMenu");
const fPrice = document.getElementById("fPrice");
const fHours = document.getElementById("fHours");
const fDesc  = document.getElementById("fDesc");
const fLat   = document.getElementById("fLat");
const fLng   = document.getElementById("fLng");
const fCancel= document.getElementById("fCancel");
const fSave  = document.getElementById("fSave");

// --- Events
[q, cat, sort].forEach(el => el.addEventListener("input", render));

tabAll.addEventListener("click", () => setTab("all"));
tabReco.addEventListener("click", () => setTab("reco"));
tabFav.addEventListener("click", () => setTab("fav"));
tabRecent.addEventListener("click", () => setTab("recent"));

useLoc.addEventListener("click", async () => {
  if(!navigator.geolocation){
    alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ê¸°ëŠ¥ì´ ì—†ë°ì´(=ì—†ìŒ).");
    return;
  }
  useLoc.disabled = true;
  useLoc.textContent = "ğŸ“ ìœ„ì¹˜ ê°€ì ¸ì˜¤ëŠ” ì¤‘...";
  navigator.geolocation.getCurrentPosition(
    (pos)=>{
      myLoc = { lat: pos.coords.latitude, lng: pos.coords.longitude, ts: Date.now() };
      saveJSON(LS_LOC, myLoc);
      useLoc.disabled = false;
      useLoc.textContent = "ğŸ“ ë‚´ ìœ„ì¹˜ ì‚¬ìš©";
      updateLocPill();
      render();
    },
    (err)=>{
      useLoc.disabled = false;
      useLoc.textContent = "ğŸ“ ë‚´ ìœ„ì¹˜ ì‚¬ìš©";
      alert("ìœ„ì¹˜ ê¶Œí•œì´ ë§‰í˜”ê±°ë‚˜ ì‹¤íŒ¨í–ˆë°ì´. ë¸Œë¼ìš°ì € ì£¼ì†Œì°½ ì˜† ğŸ”’ì—ì„œ ê¶Œí•œ í—ˆìš©í•´ë³´ì´ì†Œ.");
      console.warn(err);
    },
    { enableHighAccuracy:true, timeout: 8000 }
  );
});

addDemo.addEventListener("click", () => {
  const ids = new Set(places.map(p=>p.id));
  let added = 0;
  seed.forEach(p=>{
    if(!ids.has(p.id)){
      places.push(structPlace(p));
      added++;
    }
  });
  if(added){
    savePlaces();
    render();
  }else{
    alert("ë°ëª¨ëŠ” ì´ë¯¸ ë“¤ì–´ê°€ ìˆë°ì´(=ìˆìŒ).");
  }
});

addPlace.addEventListener("click", () => openForm(null));

reset.addEventListener("click", () => {
  q.value = "";
  cat.value = "all";
  sort.value = "reco";
  setTab("all", true);
  render();
});

exportBtn.addEventListener("click", () => {
  const payload = {
    version: 2,
    exportedAt: new Date().toISOString(),
    places,
    favs: [...favs],
    recent
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "matzip-picks-data.json";
  a.click();
  URL.revokeObjectURL(url);
});

importBtn.addEventListener("click", () => importFile.click());

importFile.addEventListener("change", async () => {
  const file = importFile.files?.[0];
  if(!file) return;
  try{
    const text = await file.text();
    const data = JSON.parse(text);

    // Accept either full export or places array
    if(Array.isArray(data)){
      places = data.map(structPlace);
    }else if(data && Array.isArray(data.places)){
      places = data.places.map(structPlace);
      if(Array.isArray(data.favs)) favs = new Set(data.favs);
      if(Array.isArray(data.recent)) recent = data.recent;
      saveSet(LS_FAVS, favs);
      saveArray(LS_RECENT, recent);
    }else{
      throw new Error("í˜•ì‹ì´ ë‹¤ë¦„");
    }
    savePlaces();
    alert("ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ! ì§€ë ¸ë‹¤ì‰(=ëë‚´ì¤Œ).");
    render();
  }catch(e){
    alert("JSON ì½ê¸° ì‹¤íŒ¨â€¦ íŒŒì¼ í˜•ì‹ í™•ì¸í•´ì£¼ì´ì†Œ.");
    console.warn(e);
  }finally{
    importFile.value = "";
  }
});

// Detail modal close
closeDetail.addEventListener("click", closeDetailModal);
detailBackdrop.addEventListener("click", (e)=>{ if(e.target===detailBackdrop) closeDetailModal(); });

// Form modal close
closeForm.addEventListener("click", closeFormModal);
fCancel.addEventListener("click", closeFormModal);
formBackdrop.addEventListener("click", (e)=>{ if(e.target===formBackdrop) closeFormModal(); });

fSave.addEventListener("click", () => {
  const data = readForm();
  if(!data.name.trim()){
    alert("ê°€ê²Œëª…ì€ í•„ìˆ˜ë‹¤ ì½”ë…¸ì•¼ë¡œ.");
    return;
  }
  if(!data.cat){
    alert("ì¹´í…Œê³ ë¦¬ë„ í•„ìˆ˜!");
    return;
  }

  if(editingId){
    const idx = places.findIndex(p=>p.id===editingId);
    if(idx>=0){
      places[idx] = { ...places[idx], ...data, updatedAt: Date.now() };
      savePlaces();
      closeFormModal();
      render();
      openDetail(editingId); // ë°”ë¡œ í™•ì¸
    }
  }else{
    const id = "p_" + Math.random().toString(36).slice(2,10);
    places.push(structPlace({ id, ...data, addedAt: Date.now() }));
    savePlaces();
    closeFormModal();
    render();
  }
});

// Detail actions
copyBtn.addEventListener("click", async () => {
  const p = getById(selectedId);
  if(!p) return;
  const text =
`[${p.name}]
ì¹´í…Œê³ ë¦¬: ${p.cat}
í‰ì : ${fmtScore(p.score)}
íƒœê·¸: ${(p.tags||[]).join(", ")}
ì£¼ì†Œ: ${p.addr||"-"}
ì¶”ì²œ ë©”ë‰´: ${p.menu||"-"}
ê°€ê²©ëŒ€: ${p.price||"-"}
ì˜ì—…: ${p.hours||"-"}
ì¢Œí‘œ: ${p.lat ?? "-"}, ${p.lng ?? "-"}`;
  try{
    await navigator.clipboard.writeText(text);
    copyBtn.textContent = "ë³µì‚¬ë¨!";
    setTimeout(()=>copyBtn.textContent="ì •ë³´ ë³µì‚¬", 900);
  }catch{
    alert("ë³µì‚¬ ì‹¤íŒ¨â€¦ ë¸Œë¼ìš°ì € ê¶Œí•œ í™•ì¸í•´ì£¼ì´ì†Œ.");
  }
});

editBtn.addEventListener("click", () => {
  const p = getById(selectedId);
  if(!p) return;
  closeDetailModal(false);
  openForm(p);
});

delBtn.addEventListener("click", () => {
  const p = getById(selectedId);
  if(!p) return;
  const ok = confirm(`"${p.name}" ì§„ì§œ ì‚­ì œí• ë¼? (ë³µêµ¬ ì•ˆ ë¨)`);
  if(!ok) return;
  places = places.filter(x=>x.id!==p.id);
  favs.delete(p.id);
  recent = recent.filter(id=>id!==p.id);
  savePlaces(); saveSet(LS_FAVS, favs); saveArray(LS_RECENT, recent);
  closeDetailModal();
  render();
});

// Maps (no API; just search)
mapKakao.addEventListener("click", ()=>openMap("kakao"));
mapNaver.addEventListener("click", ()=>openMap("naver"));
mapGoogle.addEventListener("click", ()=>openMap("google"));

// --- Init
updateLocPill();
render();

/* ============================
   Helpers & Core Logic
   ============================ */

function setTab(tab, silent){
  activeTab = tab;
  tabAll.classList.toggle("on", tab==="all");
  tabReco.classList.toggle("on", tab==="reco");
  tabFav.classList.toggle("on", tab==="fav");
  tabRecent.classList.toggle("on", tab==="recent");

  // Tab default sort hint
  if(!silent){
    if(tab==="reco") sort.value = "reco";
    if(tab==="fav") sort.value = "reco";
    if(tab==="recent") sort.value = "new";
  }
  render();
}

function loadPlaces(){
  const raw = loadJSON(LS_PLACES, null);
  if(raw && Array.isArray(raw)) return raw.map(structPlace);
  return [];
}
function savePlaces(){ saveJSON(LS_PLACES, places); }

function loadJSON(key, fallback){
  try{
    const raw = localStorage.getItem(key);
    return raw ? JSON.parse(raw) : fallback;
  }catch{ return fallback; }
}
function saveJSON(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

function loadSet(key){
  try{
    const raw = localStorage.getItem(key);
    return raw ? new Set(JSON.parse(raw)) : new Set();
  }catch{ return new Set(); }
}
function saveSet(key, set){ localStorage.setItem(key, JSON.stringify([...set])); }

function loadArray(key){
  try{
    const raw = localStorage.getItem(key);
    return raw ? JSON.parse(raw) : [];
  }catch{ return []; }
}
function saveArray(key, arr){ localStorage.setItem(key, JSON.stringify(arr)); }

function structPlace(p){
  // Normalize / ensure fields
  const tags = Array.isArray(p.tags) ? p.tags : (typeof p.tags==="string" ? p.tags.split(",").map(s=>s.trim()).filter(Boolean) : []);
  const score = numOrNull(p.score);
  const lat = numOrNull(p.lat);
  const lng = numOrNull(p.lng);
  return {
    id: p.id ?? ("p_" + Math.random().toString(36).slice(2,10)),
    name: String(p.name ?? "").trim(),
    cat: String(p.cat ?? "ê¸°íƒ€"),
    tags,
    score: (score==null ? 0 : clamp(score, 0, 5)),
    desc: String(p.desc ?? ""),
    addr: String(p.addr ?? ""),
    menu: String(p.menu ?? ""),
    price: String(p.price ?? ""),
    hours: String(p.hours ?? ""),
    lat, lng,
    addedAt: p.addedAt ?? Date.now(),
    updatedAt: p.updatedAt ?? null
  };
}

function numOrNull(v){
  if(v===null || v===undefined || v==="") return null;
  const n = Number(v);
  return Number.isFinite(n) ? n : null;
}
function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

function fmtScore(s){
  const n = Number(s);
  if(!Number.isFinite(n)) return "-";
  return n.toFixed(1).replace(/\.0$/, "");
}

function updateLocPill(){
  if(myLoc && Number.isFinite(myLoc.lat) && Number.isFinite(myLoc.lng)){
    locPill.textContent = `ğŸ“ ìœ„ì¹˜: ON (${myLoc.lat.toFixed(3)}, ${myLoc.lng.toFixed(3)})`;
  }else{
    locPill.textContent = "ğŸ“ ìœ„ì¹˜: ë¯¸ì‚¬ìš©";
  }
}

function getById(id){ return places.find(p=>p.id===id); }

function distanceKm(aLat, aLng, bLat, bLng){
  // Haversine
  const R = 6371;
  const toRad = (d)=>d*Math.PI/180;
  const dLat = toRad(bLat - aLat);
  const dLng = toRad(bLng - aLng);
  const sa = Math.sin(dLat/2)**2 +
    Math.cos(toRad(aLat))*Math.cos(toRad(bLat))*Math.sin(dLng/2)**2;
  const c = 2*Math.atan2(Math.sqrt(sa), Math.sqrt(1-sa));
  return R*c;
}

function calcRecoScore(p){
  // ì¶”ì²œ ì ìˆ˜: í‰ì (0~5) * 20 + ì¦ê²¨ì°¾ê¸° + ìµœê·¼ë³¸ + ê±°ë¦¬(ê°€ê¹Œìš¸ìˆ˜ë¡ ê°€ì )
  let score = (p.score ?? 0) * 20;

  if(favs.has(p.id)) score += 18;            // fav boost
  const idx = recent.indexOf(p.id);
  if(idx >= 0) score += Math.max(0, 14 - idx*2); // ìµœê·¼ë³¸ boost (ì•ì— ìˆì„ìˆ˜ë¡ í¼)

  // ê±°ë¦¬ ê°€ì : 0~5km = +15, 5~20km = +8, 20km~ = +0 (ì¢Œí‘œ ìˆì„ ë•Œë§Œ)
  if(myLoc && p.lat!=null && p.lng!=null){
    const km = distanceKm(myLoc.lat, myLoc.lng, p.lat, p.lng);
    if(km <= 5) score += 15;
    else if(km <= 20) score += 8;
  }

  // íƒœê·¸ ë‹¤ì–‘ì„±/ì¶©ì‹¤ë„ ì‚´ì§
  if((p.tags||[]).length >= 3) score += 2;
  return score;
}

function matchesFilters(p){
  const keyword = q.value.trim().toLowerCase();
  const inCat = (cat.value === "all") || (p.cat === cat.value);

  const inQ = !keyword || (
    (p.name||"").toLowerCase().includes(keyword) ||
    (p.addr||"").toLowerCase().includes(keyword) ||
    (p.tags||[]).some(t => (t||"").toLowerCase().includes(keyword))
  );

  // Tab filters
  let inTab = true;
  if(activeTab === "fav") inTab = favs.has(p.id);
  if(activeTab === "recent") inTab = recent.includes(p.id);
  // reco tab uses all but sorts by reco (still filter by query/cat)
  return inCat && inQ && inTab;
}

function sortList(list){
  const v = sort.value;

  if(v === "name") return list.sort((a,b)=> (a.name||"").localeCompare(b.name||"", "ko"));
  if(v === "new")  return list.sort((a,b)=> (b.addedAt||0) - (a.addedAt||0));
  if(v === "score")return list.sort((a,b)=> (b.score||0) - (a.score||0));

  if(v === "near"){
    // If no location/coords, push to bottom
    return list.sort((a,b)=>{
      const ak = (myLoc && a.lat!=null && a.lng!=null) ? distanceKm(myLoc.lat, myLoc.lng, a.lat, a.lng) : Infinity;
      const bk = (myLoc && b.lat!=null && b.lng!=null) ? distanceKm(myLoc.lat, myLoc.lng, b.lat, b.lng) : Infinity;
      return ak - bk;
    });
  }

  // default reco
  return list.sort((a,b)=> calcRecoScore(b) - calcRecoScore(a));
}

function render(){
  const filtered = places.filter(matchesFilters);
  const list = sortList(filtered);

  countPill.textContent = `${list.length} places`;
  grid.innerHTML = "";
  empty.style.display = list.length ? "none" : "block";

  list.forEach(p=>{
    const card = document.createElement("div");
    card.className = "card";

    const top = document.createElement("div");
    top.className = "row";

    const left = document.createElement("div");
    left.style.minWidth = "0";

    const name = document.createElement("div");
    name.className = "name";
    name.textContent = p.name || "(ì´ë¦„ ì—†ìŒ)";

    const meta = document.createElement("div");
    meta.className = "meta";
    meta.append(tag(p.cat || "ê¸°íƒ€"));

    // tags preview
    const tPreview = (p.tags||[]).slice(0,2).join(" Â· ");
    if(tPreview) meta.append(tag(tPreview));

    // distance preview if possible
    if(myLoc && p.lat!=null && p.lng!=null){
      const km = distanceKm(myLoc.lat, myLoc.lng, p.lat, p.lng);
      const kmTag = tag(`${km.toFixed(1)}km`);
      kmTag.classList.add("km");
      meta.append(kmTag);
    }

    // reco preview on reco tab or reco sort
    if(sort.value==="reco" || activeTab==="reco"){
      const rs = calcRecoScore(p);
      meta.append(tag(`ì¶”ì²œ ${Math.round(rs)}`));
    }

    left.append(name, meta);

    const right = document.createElement("div");
    right.className = "score";
    right.innerHTML = `${fmtScore(p.score)} <small>/5</small>`;

    top.append(left, right);

    const desc = document.createElement("div");
    desc.className = "desc";
    desc.textContent = p.desc || "ë©”ëª¨ ì—†ìŒ. (ìƒì„¸ì—ì„œ ìˆ˜ì • ê°€ëŠ¥)";

    const btns = document.createElement("div");
    btns.className = "btns";

    const detail = document.createElement("button");
    detail.className = "primary";
    detail.textContent = "ìƒì„¸ë³´ê¸°";
    detail.addEventListener("click", ()=>openDetail(p.id));

    const fav = document.createElement("button");
    fav.className = "fav";
    if(favs.has(p.id)) fav.classList.add("on");
    fav.textContent = favs.has(p.id) ? "â˜… ì €ì¥ë¨" : "â˜† ì €ì¥";
    fav.addEventListener("click", ()=>{
      toggleFav(p.id);
    });

    btns.append(detail, fav);

    card.append(top, desc, btns);
    grid.appendChild(card);
  });
}

function tag(text){
  const span = document.createElement("span");
  span.className = "tag";
  span.textContent = text;
  return span;
}

function toggleFav(id){
  if(favs.has(id)) favs.delete(id);
  else favs.add(id);
  saveSet(LS_FAVS, favs);
  render();
}

function openDetail(id){
  const p = getById(id);
  if(!p) return;
  selectedId = id;

  // push to recent
  recent = recent.filter(x=>x!==id);
  recent.unshift(id);
  recent = recent.slice(0, 20);
  saveArray(LS_RECENT, recent);

  mTitle.textContent = p.name;
  mDesc.textContent = p.desc || "";

  mMeta.innerHTML = "";
  const bits = [
    `ì¹´í…Œê³ ë¦¬: ${p.cat}`,
    `í‰ì : ${fmtScore(p.score)}`,
    `íƒœê·¸: ${(p.tags||[]).join(", ") || "-"}`
  ];

  if(myLoc && p.lat!=null && p.lng!=null){
    const km = distanceKm(myLoc.lat, myLoc.lng, p.lat, p.lng);
    bits.push(`ê±°ë¦¬: ${km.toFixed(2)} km`);
  }else{
    bits.push(`ê±°ë¦¬: (ì¢Œí‘œ/ìœ„ì¹˜ í•„ìš”)`);
  }

  bits.push(`ì¶”ì²œ ì ìˆ˜: ${Math.round(calcRecoScore(p))}`);

  bits.forEach(b=>{
    const span = document.createElement("span");
    span.className = "tag";
    span.textContent = b;
    mMeta.appendChild(span);
  });

  mAddr.textContent = p.addr || "-";
  mMenu.textContent = p.menu || "-";
  mPrice.textContent = p.price || "-";
  mHours.textContent = p.hours || "-";

  detailBackdrop.classList.add("show");
}

function closeDetailModal(clearSel=true){
  detailBackdrop.classList.remove("show");
  if(clearSel) selectedId = null;
}

function openMap(provider){
  const p = getById(selectedId);
  if(!p) return;
  const query = encodeURIComponent((p.name||"") + " " + (p.addr||""));

  if(provider==="google"){
    window.open(`https://www.google.com/maps/search/?api=1&query=${query}`, "_blank");
    return;
  }
  if(provider==="naver"){
    window.open(`https://map.naver.com/v5/search/${query}`, "_blank");
    return;
  }
  // kakao
  window.open(`https://map.kakao.com/?q=${query}`, "_blank");
}

function openForm(placeOrNull){
  editingId = placeOrNull?.id ?? null;
  fTitle.textContent = editingId ? "ë§›ì§‘ ìˆ˜ì •" : "ë§›ì§‘ ì¶”ê°€";

  // fill
  fName.value = placeOrNull?.name ?? "";
  fCat.value  = placeOrNull?.cat ?? "ê¸°íƒ€";
  fTags.value = (placeOrNull?.tags ?? []).join(", ");
  fScore.value= placeOrNull?.score ?? "";
  fAddr.value = placeOrNull?.addr ?? "";
  fMenu.value = placeOrNull?.menu ?? "";
  fPrice.value= placeOrNull?.price ?? "";
  fHours.value= placeOrNull?.hours ?? "";
  fDesc.value = placeOrNull?.desc ?? "";
  fLat.value  = placeOrNull?.lat ?? "";
  fLng.value  = placeOrNull?.lng ?? "";

  formBackdrop.classList.add("show");
}

function closeFormModal(){
  formBackdrop.classList.remove("show");
  editingId = null;
}

function readForm(){
  return {
    name: (fName.value||"").trim(),
    cat:  fCat.value,
    tags: (fTags.value||"").split(",").map(s=>s.trim()).filter(Boolean),
    score: clamp(Number(fScore.value||0), 0, 5),
    addr: (fAddr.value||"").trim(),
    menu: (fMenu.value||"").trim(),
    price:(fPrice.value||"").trim(),
    hours:(fHours.value||"").trim(),
    desc: (fDesc.value||"").trim(),
    lat:  (fLat.value===""? null : Number(fLat.value)),
    lng:  (fLng.value===""? null : Number(fLng.value))
  };
}
</script>
</body>
</html>
