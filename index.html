<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Matzip Picks</title>
  <meta name="description" content="ì´ë‹¬ì˜ ë§›ì§‘ TOP10 (â¤ï¸ ì¢‹ì•„ìš” í•©ì‚°) - ë§›ì§‘ ì¶”ì²œ ë¦¬ìŠ¤íŠ¸" />
  <style>
    :root{
      --bg0:#070A12;
      --bg1:#0B1020;
      --line:rgba(255,255,255,.12);
      --line2:rgba(255,255,255,.08);
      --text:#ECF2FF;
      --muted:rgba(236,242,255,.72);
      --muted2:rgba(236,242,255,.55);
      --accent:#7DD3FC;
      --accent2:#A7F3D0;
      --pink:#FB7185;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius:18px;
      --radius2:24px;
      --ring: 0 0 0 3px rgba(125,211,252,.22);
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Apple SD Gothic Neo, Noto Sans KR, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:
        radial-gradient(900px 500px at 20% 0%, rgba(125,211,252,.18), transparent 60%),
        radial-gradient(900px 500px at 80% 0%, rgba(167,243,208,.14), transparent 60%),
        radial-gradient(1200px 700px at 50% 120%, rgba(251,113,133,.08), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }
    .wrap{max-width:1180px;margin:0 auto;padding:18px}
    .top{
      display:flex;gap:14px;align-items:flex-start;justify-content:space-between;
      flex-wrap:wrap;margin-bottom:14px;
    }
    .brand{display:flex;gap:12px;align-items:center;min-width:280px}
    .logo{
      width:44px;height:44px;border-radius:14px;
      display:grid;place-items:center;
      background:linear-gradient(135deg, rgba(125,211,252,.26), rgba(167,243,208,.14));
      border:1px solid rgba(125,211,252,.25);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      font-size:20px;
    }
    .brand h1{margin:0;font-size:18px;letter-spacing:.2px}
    .brand .sub{margin-top:4px;font-size:12px;color:var(--muted)}
    .actionsbar{
      flex:1;
      display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;align-items:center;
    }
    .chip{
      display:flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      backdrop-filter: blur(10px);
    }
    .chip input{
      width:320px;max-width:58vw;
      border:none;outline:none;background:transparent;padding:0;
      color:var(--text);
    }
    .chip input::placeholder{color:rgba(236,242,255,.45)}

    select, input, textarea, button{font:inherit;color:var(--text)}
    input, textarea{
      background:rgba(255,255,255,.04);
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      outline:none;
    }
    input:focus, textarea:focus{box-shadow:var(--ring);border-color:rgba(125,211,252,.35)}

    /* âœ… select ê°€ë…ì„± (ìš”êµ¬ì‚¬í•­ #2) */
    select{
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.16);
      border-radius:14px;
      padding:10px 12px;
      outline:none;
      color:var(--text);
    }
    select:focus{box-shadow:var(--ring);border-color:rgba(125,211,252,.35)}
    option{background:#0B1020;color:#ECF2FF}

    textarea{min-height:96px;resize:vertical}

    button{
      cursor:pointer;
      border:1px solid var(--line);
      background:rgba(255,255,255,.05);
      border-radius:14px;
      padding:10px 12px;
      transition: .16s transform, .16s background, .16s border-color;
      white-space:nowrap; /* âœ… #3 ë²„íŠ¼ í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ ë°©ì§€ */
    }
    button:hover{background:rgba(255,255,255,.09);border-color:rgba(255,255,255,.16)}
    button:active{transform:scale(.98)}
    .btn-primary{
      background:linear-gradient(135deg, rgba(125,211,252,.26), rgba(167,243,208,.14));
      border-color:rgba(125,211,252,.35);
    }
    .btn-danger{
      background:rgba(251,113,133,.10);
      border-color:rgba(251,113,133,.35);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.6fr .9fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width:980px){.grid{grid-template-columns:1fr}}

    .panel{
      border:1px solid var(--line);
      border-radius:var(--radius2);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .panel .hd{
      padding:14px 14px 12px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      border-bottom:1px solid var(--line2);
      background:rgba(0,0,0,.14);
    }
    .panel .hd .title{display:flex;flex-direction:column;gap:4px}
    .panel .hd .title b{font-size:14px;letter-spacing:.2px}
    .panel .hd .title span{font-size:12px;color:var(--muted)}
    .panel .bd{padding:14px}

    .hint{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
      padding:10px 12px;border:1px solid var(--line2);
      border-radius:16px;background:rgba(0,0,0,.16);
      color:var(--muted);font-size:12px;line-height:1.4;
      margin-bottom:12px;
    }
    .hint .dot{width:8px;height:8px;border-radius:99px;background:rgba(167,243,208,.85)}
    .hint .dot2{background:rgba(125,211,252,.85)}
    .hint .dot3{background:rgba(251,113,133,.75)}

    .cards{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:12px;
    }
    @media (max-width:980px){.cards{grid-template-columns: repeat(2, minmax(0,1fr))}}
    @media (max-width:560px){.cards{grid-template-columns:1fr}}

    /* âœ… #3 ì¹´ë“œ í¬ê¸° í†µì¼ */
    .card{
      border:1px solid var(--line2);
      border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.10));
      padding:14px;
      display:flex;flex-direction:column;gap:9px;
      position:relative;
      overflow:hidden;
      min-height: 270px;
    }
    .card:before{
      content:"";
      position:absolute;inset:-2px;
      background:
        radial-gradient(600px 280px at 30% 0%, rgba(125,211,252,.14), transparent 55%),
        radial-gradient(600px 280px at 80% 10%, rgba(167,243,208,.10), transparent 55%);
      opacity:.55;pointer-events:none;
    }
    .card > *{position:relative}

    .badges{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .badge{
      font-size:12px;
      padding:5px 9px;
      border-radius:999px;
      border:1px solid var(--line2);
      background:rgba(0,0,0,.12);
      color:var(--muted);
      white-space:nowrap;
    }
    .badge.saved{border-color:rgba(167,243,208,.30);color:var(--accent2)}
    .name{font-size:18px;font-weight:820;letter-spacing:.1px;line-height:1.15}
    .meta{display:flex;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:12.5px}
    .meta b{color:var(--text)}
    .tags{color:var(--muted2);font-size:12px;display:flex;gap:7px;flex-wrap:wrap}
    .tag{padding:4px 8px;border:1px solid var(--line2);border-radius:999px;background:rgba(0,0,0,.12);white-space:nowrap}

    /* âœ… #4 ë¸Œë ˆì´í¬ -> ë¸Œë ˆì´í¬ íƒ€ì„ */
    .desc{
      color:rgba(236,242,255,.78);
      font-size:13.2px;line-height:1.5;
      flex:1;
      min-height: 48px;
    }

    /* âœ… #3 í•˜ë‹¨ ë²„íŠ¼ ì¼ì ì •ë ¬ + ë™ì¼ ë†’ì´ + ì €ì¥ë¨ 1ì¤„ */
    .btns{display:flex;gap:9px;margin-top:6px;align-items:stretch}
    .btns button{
      flex:1;
      height:42px;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:10px 12px;
      min-width:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .toplist{display:flex;flex-direction:column;gap:10px}
    .topitem{
      padding:10px 12px;
      border:1px solid var(--line2);
      border-radius:16px;
      background:rgba(0,0,0,.14);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .rankleft{display:flex;align-items:center;gap:10px;min-width:0}
    .rankno{
      width:30px;height:30px;border-radius:10px;
      display:grid;place-items:center;
      border:1px solid var(--line2);
      background:rgba(255,255,255,.03);
      color:var(--muted);
      font-weight:800;
      flex:0 0 auto;
    }
    .rankname{
      min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      font-weight:750;
    }
    .ranklikes{font-weight:850}
    .small{font-size:12px;color:var(--muted)}
    .muted{color:var(--muted)}
    .footnote{margin-top:10px;color:var(--muted);font-size:12px;line-height:1.45}

    /* âœ… #1 ëª¨ë‹¬ íˆ¬ëª…ë„ ì œê±° */
    .overlay{
      position:fixed;inset:0;
      display:none;align-items:center;justify-content:center;
      background:rgba(0,0,0,.62);
      padding:18px;
      z-index:50;
    }
    .modal{
      width:min(820px, 100%);
      border-radius:22px;
      border:1px solid rgba(255,255,255,.14);
      background:#0C1224;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .modal .hd{
      padding:14px 14px 10px;
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background:#0B1020;
    }
    .modal .hd .left{min-width:0}
    .modal .hd .left .mname{font-size:18px;font-weight:850;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .modal .hd .left .msub{margin-top:4px;font-size:12px;color:var(--muted)}
    .modal .bd{padding:14px;background:#0C1224}
    .modal .ft{
      padding:14px;border-top:1px solid rgba(255,255,255,.10);
      display:flex;gap:10px;background:#0B1020;
    }
    .modal .ft button{flex:1}
    .btn-like{
      background:linear-gradient(135deg, rgba(251,113,133,.18), rgba(125,211,252,.14));
      border-color:rgba(251,113,133,.35);
    }
    .btn-save{
      background:linear-gradient(135deg, rgba(167,243,208,.18), rgba(125,211,252,.10));
      border-color:rgba(167,243,208,.30);
    }
    .kvgrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:640px){.kvgrid{grid-template-columns:1fr}}
    .kv{
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      background:#0B1020;
      padding:10px 12px;
    }
    .kv .k{font-size:11px;color:var(--muted);margin-bottom:6px}
    .kv .v{font-weight:750}
    .review{
      margin-top:10px;border:1px solid rgba(255,255,255,.10);
      border-radius:16px;background:#0B1020;padding:12px;
    }
    .review .k{font-size:11px;color:var(--muted);margin-bottom:8px}
    .review .v{font-weight:650;line-height:1.55;color:rgba(236,242,255,.86)}

    .formgrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:700px){.formgrid{grid-template-columns:1fr}}
    .formgrid .full{grid-column:1/-1}

    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:rgba(0,0,0,.78);
      border:1px solid rgba(255,255,255,.12);
      padding:10px 12px;border-radius:14px;
      color:var(--text);
      display:none;
      z-index:60;
      box-shadow: 0 14px 40px rgba(0,0,0,.35);
      font-size:13px;
      backdrop-filter: blur(10px);
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo">ğŸœ</div>
        <div>
          <h1>Matzip Picks</h1>
          <div class="sub">ì´ë‹¬ TOP10(â¤ï¸ ì¢‹ì•„ìš” í•©ì‚°) Â· â­ ì €ì¥ì€ ë‚´ ë¸Œë¼ìš°ì €</div>
        </div>
      </div>

      <div class="actionsbar">
        <div class="chip">
          ğŸ”
          <input id="q" placeholder="ê²€ìƒ‰: ìƒí˜¸/ì¹´í…Œê³ ë¦¬/íƒœê·¸/ë¸Œë ˆì´í¬ íƒ€ì„" />
        </div>

        <select id="cat">
          <option value="">ì¹´í…Œê³ ë¦¬: ì „ì²´</option>
          <option>í•œì‹</option><option>ì¼ì‹</option><option>ì¤‘ì‹</option><option>ì–‘ì‹</option><option>ë¶„ì‹</option>
          <option>ì¹´í˜</option><option>ìˆ ì§‘</option><option>ë””ì €íŠ¸</option><option>ê¸°íƒ€</option>
        </select>

        <select id="sort">
          <option value="rec">ì •ë ¬: ì¶”ì²œìˆœ</option>
          <option value="rate">ì •ë ¬: í‰ì ìˆœ</option>
          <option value="new">ì •ë ¬: ìµœì‹ ìˆœ</option>
        </select>

        <button id="openAdd" class="btn-primary">+ ë§›ì§‘ ì¶”ê°€</button>
        <button id="addDemo">+ ë°ëª¨ 3ê°œ</button>
        <button id="reset" class="btn-danger">ë¦¬ì…‹</button>
      </div>
    </div>

    <div class="grid">
      <section class="panel">
        <div class="hd">
          <div class="title">
            <b>ğŸ½ï¸ ë§›ì§‘ ë¦¬ìŠ¤íŠ¸</b>
            <span id="count">0 places</span>
          </div>
          <div class="small">â¤ï¸ = êµ¬ê¸€ì‹œíŠ¸ í•©ì‚° / â­ = ë‚´ ë¸Œë¼ìš°ì € ì €ì¥</div>
        </div>
        <div class="bd">
          <div class="hint">
            <span class="dot"></span> â¤ï¸ëŠ” â€œìƒì„¸ë³´ê¸°â€ì—ì„œ ëˆ„ë¥´ë©´ TOP10ì— ë°˜ì˜ë¨
            <span class="dot2"></span> ë¸Œë ˆì´í¬ íƒ€ì„ ì…ë ¥ ê°€ëŠ¥ (ì—†ìœ¼ë©´ â€œì—†ìŒ/ë¯¸ê¸°ì…â€)
            <span class="dot3"></span> ê³ ì¥ë‚˜ë©´ F12 ì½˜ì†”ì— ì—ëŸ¬ ëœ¸(ë‚´ê°€ ì¡ì•„ì¤Œ)
          </div>
          <div class="cards" id="places"></div>
        </div>
      </section>

      <aside class="panel">
        <div class="hd">
          <div class="title">
            <b>ğŸ† ì´ë‹¬ì˜ ë§›ì§‘ TOP10</b>
            <span id="topSubtitle"></span>
          </div>
          <button id="refreshTop">ìƒˆë¡œê³ ì¹¨</button>
        </div>
        <div class="bd">
          <div id="topList" class="toplist"></div>
          <div class="footnote">
            TIP: ë°ëª¨ ë„£ê³  â¤ï¸ ëˆ„ë¥´ë©´ ìˆœìœ„ê°€ ë°”ë¡œ ë°”ë€Œì–´ì•¼ ì •ìƒì´ë‹¤ì‰.
          </div>
        </div>
      </aside>
    </div>
  </div>

  <!-- Detail modal -->
  <div class="overlay" id="detailOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="hd">
        <div class="left">
          <div class="mname" id="dName">-</div>
          <div class="msub" id="dSub">-</div>
        </div>
        <button id="closeDetail">ë‹«ê¸°</button>
      </div>
      <div class="bd">
        <div class="kvgrid">
          <div class="kv"><div class="k">ì¹´í…Œê³ ë¦¬</div><div class="v" id="dCat">-</div></div>
          <div class="kv"><div class="k">í‰ì </div><div class="v" id="dRate">-</div></div>
          <div class="kv"><div class="k">ì˜ì—…ì‹œê°„</div><div class="v" id="dHours">-</div></div>
          <div class="kv"><div class="k">ë¸Œë ˆì´í¬ íƒ€ì„</div><div class="v" id="dBreak">-</div></div>
          <div class="kv"><div class="k">ì£¼ì†Œ/ìœ„ì¹˜ ë©”ëª¨</div><div class="v" id="dAddr">-</div></div>
          <div class="kv"><div class="k">íƒœê·¸</div><div class="v" id="dTags">-</div></div>
        </div>
        <div class="review">
          <div class="k">í•œ ì¤„ ë¦¬ë·°</div>
          <div class="v" id="dNote">-</div>
        </div>
      </div>
      <div class="ft">
        <button id="toggleSave" class="btn-save">â­ ì €ì¥</button>
        <button id="likeBtn" class="btn-like">â¤ï¸ ì¢‹ì•„ìš”</button>
      </div>
    </div>
  </div>

  <!-- Add modal -->
  <div class="overlay" id="addOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="hd">
        <div class="left">
          <div class="mname">+ ë§›ì§‘ ì¶”ê°€</div>
          <div class="msub">ë¸Œë ˆì´í¬ íƒ€ì„ë„ ì…ë ¥í•´ë¼ì‰ (ì˜ˆ: 15:00~17:00 / ì—†ìŒ)</div>
        </div>
        <button id="closeAdd">ë‹«ê¸°</button>
      </div>
      <div class="bd">
        <div class="formgrid">
          <input id="aName" placeholder="ìƒí˜¸ëª… (í•„ìˆ˜)" />
          <select id="aCat">
            <option value="">ì¹´í…Œê³ ë¦¬(í•„ìˆ˜)</option>
            <option>í•œì‹</option><option>ì¼ì‹</option><option>ì¤‘ì‹</option><option>ì–‘ì‹</option><option>ë¶„ì‹</option>
            <option>ì¹´í˜</option><option>ìˆ ì§‘</option><option>ë””ì €íŠ¸</option><option>ê¸°íƒ€</option>
          </select>

          <input id="aRate" placeholder="í‰ì  (ì˜ˆ: 4.6 / ë¹„ì›Œë„ ë¨)" />
          <input id="aAddr" placeholder="ì£¼ì†Œ/ìœ„ì¹˜ ë©”ëª¨ (ì„ íƒ)" />

          <input id="aHours" placeholder="ì˜ì—…ì‹œê°„ (ì˜ˆ: 11:00~21:00)" />
          <input id="aBreak" placeholder="ë¸Œë ˆì´í¬ íƒ€ì„ (ì˜ˆ: 15:00~17:00 / ì—†ìŒ)" />

          <input id="aTags" class="full" placeholder="íƒœê·¸ (ì‰¼í‘œë¡œ êµ¬ë¶„: ì„±ìˆ˜,í˜¼ë°¥,ë°ì´íŠ¸)" />
          <textarea id="aNote" class="full" placeholder="í•œ ì¤„ ë¦¬ë·°(í•„ìˆ˜) ì˜ˆ: êµ­ë¬¼ ê¹”ë”í•˜ê³  íšŒì „ ë¹ ë¦„."></textarea>
        </div>

        <div class="footnote">
          * ë§›ì§‘ ë“±ë¡/ì €ì¥ì€ ë‚´ ë¸Œë¼ìš°ì €(localStorage).<br/>
          * â¤ï¸ ì¢‹ì•„ìš”ëŠ” êµ¬ê¸€ì‹œíŠ¸ë¡œ í•©ì‚°ë˜ì–´ TOP10ì— ë°˜ì˜ë¨.
        </div>
      </div>
      <div class="ft">
        <button id="addPlace" class="btn-primary">ì¶”ê°€</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">ì €ì¥ë¨</div>

<script>
/* ============================
   âœ… Apps Script Web App URL
   ============================ */
const LIKE_API_URL = "https://script.google.com/macros/s/AKfycbw8lCybnmrH3QSloTRpLeHRFno9kp3AlldKK9AvOlx8V1ECrq51CJZSyzVZBNLInb0SDA/exec";

/* ============================
   Storage / State
   ============================ */
const LS_KEY   = "matzip_picks_places_v4";
const LS_SAVED = "matzip_picks_saved_v4";

let places = loadPlaces_();
let savedMap = loadSaved_();
let selectedId = null;

const $ = (id)=>document.getElementById(id);

function ymNow(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  return `${y}-${m}`;
}
function uid(){
  return "p_" + Math.random().toString(36).slice(2,9) + "_" + Date.now().toString(36);
}
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}

function toast(msg){
  const t = $("toast");
  t.textContent = msg;
  t.style.display = "block";
  clearTimeout(window.__toastTimer);
  window.__toastTimer = setTimeout(()=>{ t.style.display="none"; }, 1400);
}

function loadPlaces_(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(raw){
      const arr = JSON.parse(raw);
      if(Array.isArray(arr)) return arr;
    }
  }catch(e){}
  return [];
}
function savePlaces_(){ localStorage.setItem(LS_KEY, JSON.stringify(places)); }

function loadSaved_(){
  try{
    const raw = localStorage.getItem(LS_SAVED);
    if(raw) return JSON.parse(raw) || {};
  }catch(e){}
  return {};
}
function saveSaved_(){ localStorage.setItem(LS_SAVED, JSON.stringify(savedMap)); }

/* ============================
   Render list
   ============================ */
function renderList(){
  const q = ($("q").value || "").trim().toLowerCase();
  const cat = $("cat").value;
  const sort = $("sort").value;

  let arr = [...places];

  if(cat) arr = arr.filter(p => (p.category || "") === cat);

  if(q){
    arr = arr.filter(p => {
      const hay = [
        p.name, p.category, p.tags, p.note, p.address, p.hours, p.breakTime
      ].join(" ").toLowerCase();
      return hay.includes(q);
    });
  }

  if(sort === "rate"){
    arr.sort((a,b)=>(Number(b.rating||0) - Number(a.rating||0)));
  }else if(sort === "new"){
    arr.sort((a,b)=>(Number(b.createdAt||0)-Number(a.createdAt||0)));
  }else{
    arr.sort((a,b)=>{
      const sa = savedMap[a.id] ? 1 : 0;
      const sb = savedMap[b.id] ? 1 : 0;
      if(sb !== sa) return sb - sa;
      return Number(b.rating||0) - Number(a.rating||0);
    });
  }

  $("count").textContent = `${arr.length} places`;

  const el = $("places");
  if(!arr.length){
    el.innerHTML = `<div class="muted">ì•„ì§ ë“±ë¡ëœ ë§›ì§‘ì´ ì—†ë‹¤â€¦ + ë°ëª¨ 3ê°œ ë„£ê³  ìŠ¤íƒ€íŠ¸í•´ë³´ìì‰ ğŸ˜</div>`;
    return;
  }

  el.innerHTML = arr.map(p=>{
    const isSaved = !!savedMap[p.id];
    const tags = (p.tags||"").split(",").map(s=>s.trim()).filter(Boolean).slice(0,4);

    const badgeSaved = isSaved ? `<span class="badge saved">â­ ì €ì¥ë¨</span>` : "";
    const ratingTxt = (p.rating ?? "-");
    const hoursTxt  = p.hours ? `ì˜ì—… <b>${escapeHtml(p.hours)}</b>` : `ì˜ì—… <b>-</b>`;
    const breakTxt  = p.breakTime ? `ë¸Œë ˆì´í¬ íƒ€ì„ <b>${escapeHtml(p.breakTime)}</b>` : `ë¸Œë ˆì´í¬ íƒ€ì„ <b>ì—†ìŒ/ë¯¸ê¸°ì…</b>`;

    return `
      <div class="card">
        <div class="badges">
          <span class="badge">${escapeHtml(p.category||"ê¸°íƒ€")}</span>
          ${badgeSaved}
        </div>

        <div class="name">${escapeHtml(p.name)}</div>

        <div class="meta">
          <span>í‰ì  <b>${escapeHtml(String(ratingTxt))}</b></span>
          <span>Â· ${hoursTxt}</span>
        </div>

        <div class="meta">
          <span>${breakTxt}</span>
        </div>

        <div class="tags">
          ${(tags.length ? tags : ["íƒœê·¸ì—†ìŒ"]).map(t=>`<span class="tag">#${escapeHtml(t)}</span>`).join("")}
        </div>

        <div class="desc">${escapeHtml(p.note||"")}</div>

        <div class="btns">
          <button onclick="openDetail('${p.id}')">ìƒì„¸ë³´ê¸°</button>
          <button onclick="toggleSave('${p.id}')" class="${isSaved ? 'btn-primary':''}">
            ${isSaved ? 'â­ ì €ì¥ë¨' : 'â­ ì €ì¥'}
          </button>
        </div>
      </div>
    `;
  }).join("");
}

/* ============================
   Detail modal
   ============================ */
window.openDetail = function(id){
  selectedId = id;
  const p = places.find(x=>x.id===id);
  if(!p) return;

  $("dName").textContent  = p.name || "-";
  $("dSub").textContent   = `${p.category || "ê¸°íƒ€"} Â· ${p.address ? p.address : "ì£¼ì†Œ/ìœ„ì¹˜: ë¯¸ìƒ"}`;
  $("dCat").textContent   = p.category || "-";
  $("dRate").textContent  = (p.rating ?? "-");
  $("dHours").textContent = p.hours || "ë¯¸ê¸°ì…";
  $("dBreak").textContent = p.breakTime || "ì—†ìŒ/ë¯¸ê¸°ì…";
  $("dAddr").textContent  = p.address || "ë¯¸ê¸°ì…";
  $("dTags").textContent  = (p.tags || "ì—†ìŒ").split(",").map(s=>s.trim()).filter(Boolean).map(t=>`#${t}`).join(" ") || "ì—†ìŒ";
  $("dNote").textContent  = p.note || "-";

  $("toggleSave").textContent = savedMap[p.id] ? "â­ ì €ì¥ë¨" : "â­ ì €ì¥";
  openOverlay_("detailOverlay");
}
function closeDetail(){ closeOverlay_("detailOverlay"); }

/* ============================
   Save toggle
   ============================ */
window.toggleSave = function(id){
  savedMap[id] = !savedMap[id];
  if(!savedMap[id]) delete savedMap[id];
  saveSaved_();
  renderList();
  if(selectedId === id) $("toggleSave").textContent = savedMap[id] ? "â­ ì €ì¥ë¨" : "â­ ì €ì¥";
  toast(savedMap[id] ? "â­ ì €ì¥ë¨" : "ì €ì¥ í•´ì œ");
}

/* ============================
   Likes (GET ë°©ì‹)
   ============================ */
async function likeMonthly(){
  if(!selectedId){
    alert("ë¨¼ì € ë§›ì§‘ ìƒì„¸ë³´ê¸° ì—´ê³  â¤ï¸ ëˆŒëŸ¬ë¼ì‰.");
    return;
  }
  const p = places.find(x=>x.id===selectedId);
  if(!p || !p.id){
    alert("placeIdë¥¼ ëª» ì°¾ì•˜ë‹¤â€¦");
    return;
  }

  const month = ymNow();

  // (ì„ íƒ) ê°™ì€ ë¸Œë¼ìš°ì € ì›” 1íšŒ ì œí•œ (ì›í•˜ë©´ ìœ ì§€)
  const key = `liked_${month}_${p.id}`;
  if(localStorage.getItem(key)){
    alert("ì´ë²ˆ ë‹¬ì— ì´ ê°€ê²ŒëŠ” ì´ë¯¸ ì¢‹ì•„ìš” í–ˆë‹¤ ì•„ì´ê°€ ğŸ˜…");
    return;
  }

  try{
    $("likeBtn").disabled = true;
    $("likeBtn").textContent = "â¤ï¸ ë°˜ì˜ì¤‘...";

    const url = `${LIKE_API_URL}?action=like&month=${encodeURIComponent(month)}&placeId=${encodeURIComponent(p.id)}`;
    const res = await fetch(url);
    const data = await res.json();

    if(!data.ok) throw new Error(data.error || "like failed");

    localStorage.setItem(key, "1");
    toast(`â¤ï¸ +1 (ì´ë²ˆë‹¬ ${data.likes})`);
    await refreshMonthlyRanking();
  }catch(e){
    console.warn(e);
    alert("ì¢‹ì•„ìš” ì‹¤íŒ¨â€¦ (ë°°í¬/ê¶Œí•œ/URL í™•ì¸) F12 ì½˜ì†”ë„ ë´ë¼ì‰.");
  }finally{
    $("likeBtn").disabled = false;
    $("likeBtn").textContent = "â¤ï¸ ì¢‹ì•„ìš”";
  }
}

function nameById_(placeId){
  const p = places.find(x=>x.id === placeId);
  return p ? p.name : placeId;
}

async function refreshMonthlyRanking(){
  const month = ymNow();
  $("topSubtitle").textContent = `${month} ê¸°ì¤€ Â· ëª¨ë‘ì˜ ì¢‹ì•„ìš” í•©ì‚°`;

  try{
    const url = `${LIKE_API_URL}?action=rank&month=${encodeURIComponent(month)}`;
    const res = await fetch(url);
    const data = await res.json();
    const ranking = data.ranking || [];

    if(!ranking.length){
      $("topList").innerHTML = `
        <div class="topitem">
          <div class="rankleft">
            <div class="rankno">?</div>
            <div class="rankname muted">ì•„ì§ ì¢‹ì•„ìš”ê°€ ì—†ë‹¤â€¦ 1ë“±ì€ ë‹ˆê°€ ë§Œë“ ë‹¤ ğŸ˜</div>
          </div>
          <div class="ranklikes muted">0â¤ï¸</div>
        </div>
      `;
      return;
    }

    $("topList").innerHTML = ranking.slice(0,10).map((r,i)=>{
      const name = nameById_(r.placeId);
      const likes = r.likes ?? 0;

      return `
        <div class="topitem">
          <div class="rankleft">
            <div class="rankno">${i+1}</div>
            <div class="rankname">${escapeHtml(name)}</div>
          </div>
          <div class="ranklikes">${likes}â¤ï¸</div>
        </div>
      `;
    }).join("");
  }catch(err){
    console.warn(err);
    $("topList").innerHTML = `
      <div class="topitem">
        <div class="rankleft">
          <div class="rankno">!</div>
          <div class="rankname muted">ë­í‚¹ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨â€¦ (F12 ì½˜ì†” í™•ì¸)</div>
        </div>
        <div class="ranklikes muted">-</div>
      </div>
    `;
  }
}

/* ============================
   Add place
   ============================ */
function openAdd(){ openOverlay_("addOverlay"); }
function closeAdd(){ closeOverlay_("addOverlay"); }

function addPlace(){
  const name = $("aName").value.trim();
  const category = $("aCat").value.trim();
  const ratingRaw = $("aRate").value.trim();
  const hours = $("aHours").value.trim();
  const breakTime = $("aBreak").value.trim();
  const tags = $("aTags").value.trim();
  const address = $("aAddr").value.trim();
  const note = $("aNote").value.trim();

  if(!name){ alert("ìƒí˜¸ëª…ì€ í•„ìˆ˜ë‹¤ ì•„ì´ê°€."); return; }
  if(!category){ alert("ì¹´í…Œê³ ë¦¬ëŠ” í•„ìˆ˜ë‹¤ ì•„ì´ê°€."); return; }
  if(!note){ alert("í•œ ì¤„ ë¦¬ë·°ëŠ” í•„ìˆ˜ë‹¤ ì•„ì´ê°€."); return; }

  const rating = ratingRaw ? Number(ratingRaw) : null;

  const p = {
    id: uid(),
    name,
    category,
    rating: (Number.isFinite(rating) ? Math.round(rating*10)/10 : null),
    hours: hours || "",
    breakTime: breakTime || "",
    tags: tags || "",
    address: address || "",
    note,
    createdAt: Date.now()
  };

  places.unshift(p);
  savePlaces_();
  clearAddForm_();
  closeAdd();
  renderList();
  refreshMonthlyRanking();
  toast("âœ… ë§›ì§‘ ì¶”ê°€ë¨");
}

function clearAddForm_(){
  $("aName").value="";
  $("aCat").value="";
  $("aRate").value="";
  $("aHours").value="";
  $("aBreak").value="";
  $("aTags").value="";
  $("aAddr").value="";
  $("aNote").value="";
}

/* ============================
   Demo / Reset
   ============================ */
function addDemo(){
  const now = Date.now();
  const demo = [
    {
      id:"s1",
      name:"ì„±ìˆ˜ êµ­ë°¥ì§‘",
      category:"í•œì‹",
      rating:4.6,
      hours:"11:00~21:00",
      breakTime:"15:00~17:00",
      tags:"ì„±ìˆ˜,í˜¼ë°¥,êµ­ë°¥",
      address:"ì„±ìˆ˜ë™(ë©”ëª¨)",
      note:"í‡´ê·¼í•˜ê³  í•œ ê·¸ë¦‡ ë•Œë¦¬ê¸° ë”± ì¢‹ë‹¤ ì•„ì´ê°€(=ì¢‹ìŒ). êµ­ë¬¼ ê¹”ë”, íšŒì „ ë¹ ë¦„.",
      createdAt: now-30000
    },
    {
      id:"s2",
      name:"ì„ì§€ë¡œ ë¼ë©˜",
      category:"ì¼ì‹",
      rating:4.7,
      hours:"12:00~22:00",
      breakTime:"ì—†ìŒ",
      tags:"ì„ì§€ë¡œ,ë¼ë©˜",
      address:"",
      note:"ì§„í•œ ëˆì½”ì¸ . ì›¨ì´íŒ… ìˆì„ ìˆ˜ ìˆìœ¼ë‹ˆ íƒ€ì´ë° ì˜ ë´ë¼ì‰(=ì¡°ì ˆí•´).",
      createdAt: now-20000
    },
    {
      id:"s3",
      name:"ì—°ë‚¨ íŒŒìŠ¤íƒ€ ë°”",
      category:"ì–‘ì‹",
      rating:4.4,
      hours:"11:30~21:30",
      breakTime:"15:30~17:00",
      tags:"ì—°ë‚¨,ë°ì´íŠ¸",
      address:"",
      note:"ë¶„ìœ„ê¸° good vibes(ê°ì„± ì¢‹ìŒ). ë©´ ìµí˜ ì•ˆì •ì , ì™€ì¸ë„ ìˆìŒ.",
      createdAt: now-10000
    }
  ];

  for(const d of demo){
    const idx = places.findIndex(x=>x.id===d.id);
    if(idx>=0) places[idx] = {...places[idx], ...d};
    else places.push(d);
  }

  savePlaces_();
  renderList();
  refreshMonthlyRanking();
  toast("ë°ëª¨ ì¶”ê°€ë¨");
}

function resetAll(){
  if(!confirm("ì§„ì§œ ë¦¬ì…‹í• ê±°ê°€? (ë§›ì§‘/ì €ì¥/ì¢‹ì•„ìš” ë¡œì»¬ ê¸°ë¡ ë‹¤ ë‚ ì•„ê°)")) return;

  localStorage.removeItem(LS_KEY);
  localStorage.removeItem(LS_SAVED);

  const month = ymNow();
  Object.keys(localStorage).forEach(k=>{
    if(k.startsWith(`liked_${month}_`)) localStorage.removeItem(k);
  });

  places = [];
  savedMap = {};
  selectedId = null;

  renderList();
  refreshMonthlyRanking();
  toast("ë¦¬ì…‹ ì™„ë£Œ");
}

/* ============================
   Overlay helpers / Wiring
   ============================ */
function openOverlay_(id){
  const el = $(id);
  el.style.display = "flex";
  el.setAttribute("aria-hidden","false");
}
function closeOverlay_(id){
  const el = $(id);
  el.style.display = "none";
  el.setAttribute("aria-hidden","true");
}

$("q").addEventListener("input", renderList);
$("cat").addEventListener("change", renderList);
$("sort").addEventListener("change", renderList);

$("openAdd").addEventListener("click", openAdd);
$("closeAdd").addEventListener("click", closeAdd);
$("addPlace").addEventListener("click", addPlace);

$("addDemo").addEventListener("click", addDemo);
$("reset").addEventListener("click", resetAll);

$("refreshTop").addEventListener("click", refreshMonthlyRanking);

$("closeDetail").addEventListener("click", closeDetail);
$("toggleSave").addEventListener("click", ()=>toggleSave(selectedId));
$("likeBtn").addEventListener("click", likeMonthly);

// backdrop click close
$("detailOverlay").addEventListener("click", (e)=>{ if(e.target.id==="detailOverlay") closeDetail(); });
$("addOverlay").addEventListener("click", (e)=>{ if(e.target.id==="addOverlay") closeAdd(); });

// esc close
window.addEventListener("keydown", (e)=>{
  if(e.key === "Escape"){
    closeDetail();
    closeAdd();
  }
});

// initial
renderList();
refreshMonthlyRanking();
</script>
</body>
</html>
