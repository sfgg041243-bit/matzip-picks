<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ë§›ì§‘ ì¶”ì²œ - Matzip Picks</title>
  <style>
    :root{
      --bg:#0b0f19; --card:#121a2a; --muted:#94a3b8; --text:#e5e7eb;
      --accent:#60a5fa; --good:#34d399; --warn:#fbbf24; --danger:#fb7185;
      --line:#22314f;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;
      background:linear-gradient(180deg,#070a12, #0b0f19); color:var(--text);}
    header{position:sticky; top:0; backdrop-filter: blur(10px);
      background:rgba(11,15,25,.74); border-bottom:1px solid rgba(34,49,79,.6); z-index:10;}
    .wrap{max-width:1120px; margin:0 auto; padding:18px 16px;}
    .top{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;}
    h1{font-size:20px; margin:0; letter-spacing:.2px}
    .pill{font-size:12px; color:var(--muted); border:1px solid rgba(34,49,79,.9);
      padding:6px 10px; border-radius:999px; background:rgba(15,23,42,.35)}
    .controls{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px}
    input, select, button, textarea{
      background:rgba(18,26,42,.95); color:var(--text);
      border:1px solid rgba(34,49,79,.9); border-radius:12px;
      padding:10px 12px; font-size:14px; outline:none;
    }
    textarea{min-height:84px; resize:vertical}
    input{min-width:260px}
    button{cursor:pointer}
    button.primary{border-color:rgba(96,165,250,.7)}
    button.good{border-color:rgba(52,211,153,.7)}
    button.warn{border-color:rgba(251,191,36,.7)}
    button.danger{border-color:rgba(251,113,133,.7)}
    button.ghost{background:transparent}
    button:disabled{opacity:.55; cursor:not-allowed}
    main{padding:16px 0 60px}

    .grid{display:grid; grid-template-columns:repeat(3,1fr); gap:12px}
    @media (max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:560px){.grid{grid-template-columns:1fr} input{min-width:0; flex:1}}

    .card{
      background:rgba(18,26,42,.92);
      border:1px solid rgba(34,49,79,.9);
      border-radius:18px;
      padding:14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      transition:transform .12s ease, border-color .12s ease;
    }
    .card:hover{transform:translateY(-2px); border-color:rgba(96,165,250,.65)}
    .row{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .name{font-weight:800; font-size:16px; margin:2px 0 6px}
    .meta{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .tag{font-size:12px; color:var(--muted); border:1px solid rgba(34,49,79,.9);
      padding:4px 8px; border-radius:999px; background:rgba(15,23,42,.25)}
    .tag.km{color:#c7d2fe}
    .score{font-weight:800}
    .score small{font-weight:600; color:var(--muted)}
    .desc{color:var(--muted); font-size:13px; line-height:1.45; margin:10px 0 12px; min-height:38px}
    .btns{display:flex; gap:8px; flex-wrap:wrap}
    .fav{border-color:rgba(52,211,153,.7)}
    .fav.on{background:rgba(52,211,153,.12)}
    .empty{color:var(--muted); padding:20px 4px}
    .hint{color:var(--muted); font-size:12px; margin-top:10px}
    .hr{height:1px; background:rgba(34,49,79,.75); margin:14px 0}
    .small{font-size:12px; color:var(--muted)}

    /* Modal */
    .backdrop{position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; padding:16px}
    .backdrop.show{display:flex}
    .modal{
      width:min(820px,100%); background:rgba(18,26,42,.98);
      border:1px solid rgba(34,49,79,.9); border-radius:18px; padding:16px;
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
    }
    .modal h2{margin:0 0 8px; font-size:18px}
    .modal .close{float:right}
    .kvs{display:grid; grid-template-columns:140px 1fr; gap:10px; margin-top:12px}
    .kvs div{padding:10px 12px; border:1px solid rgba(34,49,79,.9); border-radius:14px; color:var(--muted); background:rgba(15,23,42,.2)}
    .kvs b{color:var(--text)}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width:760px){.grid2{grid-template-columns:1fr}}
    .formRow{display:flex; flex-direction:column; gap:6px}
    .formRow label{font-size:12px; color:var(--muted)}
    .split{display:flex; gap:10px; flex-wrap:wrap}
    .split > *{flex:1}
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="top">
      <div style="display:flex; align-items:center; gap:10px;">
        <h1>ğŸœ Matzip Picks</h1>
        <span class="pill">ì´ë‹¬ì˜ ë§›ì§‘ TOP10(â¤ï¸ ì¢‹ì•„ìš” í•©ì‚°) Â· GitHub Pages</span>
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <span class="pill" id="countPill">0 places</span>
        <span class="pill" id="locPill">ğŸ“ ìœ„ì¹˜: ë¯¸ì‚¬ìš©</span>
      </div>
    </div>

    <div class="controls">
      <input id="q" placeholder="ê²€ìƒ‰: ìƒí˜¸/íƒœê·¸/ì£¼ì†Œ (ì˜ˆ: ì„±ìˆ˜, íŒŒìŠ¤íƒ€, í˜¼ë°¥)"/>
      <select id="cat">
        <option value="all">ì¹´í…Œê³ ë¦¬: ì „ì²´</option>
        <option value="í•œì‹">í•œì‹</option>
        <option value="ì¼ì‹">ì¼ì‹</option>
        <option value="ì¤‘ì‹">ì¤‘ì‹</option>
        <option value="ì–‘ì‹">ì–‘ì‹</option>
        <option value="ì¹´í˜">ì¹´í˜</option>
        <option value="ìˆ ì§‘">ìˆ ì§‘</option>
        <option value="ê¸°íƒ€">ê¸°íƒ€</option>
      </select>
      <select id="sort">
        <option value="reco">ì •ë ¬: ì¶”ì²œìˆœ</option>
        <option value="score">ì •ë ¬: í‰ì ìˆœ</option>
        <option value="near">ì •ë ¬: ê°€ê¹Œìš´ìˆœ</option>
        <option value="new">ì •ë ¬: ìµœì‹ ì¶”ê°€</option>
        <option value="name">ì •ë ¬: ì´ë¦„ìˆœ</option>
      </select>

      <button class="good" id="useLoc">ğŸ“ ë‚´ ìœ„ì¹˜ ì‚¬ìš©</button>
      <button class="primary" id="addPlace">+ ë§›ì§‘ ì¶”ê°€</button>
      <button class="ghost" id="addDemo">+ ë°ëª¨ 3ê°œ ì¶”ê°€</button>
      <button class="ghost" id="reset">ë¦¬ì…‹</button>
    </div>

    <div class="hint">
      âœ… â€œâ¤ï¸ ì¢‹ì•„ìš” TOP10â€ì€ ëª¨ë“  ì‚¬ìš©ì í•©ì‚°(êµ¬ê¸€ì‹œíŠ¸).  
      âœ… â€œâ˜†ì €ì¥â€ì€ ê°œì¸ ì¦ê²¨ì°¾ê¸°(ë‚´ ë¸Œë¼ìš°ì € ì €ì¥).
    </div>
  </div>
</header>

<main class="wrap">
  <!-- Monthly ranking -->
  <div class="card" id="monthlyBox" style="margin-bottom:12px;">
    <div class="row">
      <div>
        <div class="name">ğŸ† ì´ë‹¬ì˜ ë§›ì§‘ TOP 10 (â¤ï¸ ì¢‹ì•„ìš”)</div>
        <div class="small" id="monthlyMonth">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
      </div>
      <button class="ghost" id="reloadRank">ìƒˆë¡œê³ ì¹¨</button>
    </div>
    <div class="hr"></div>
    <div id="monthlyList" class="small">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    <div class="small" style="margin-top:10px;">
      * ì¢‹ì•„ìš”ëŠ” â€œë¸Œë¼ìš°ì €ë‹¹ ì›” 1íšŒ/ê°€ê²Œâ€ ì •ë„ë§Œ ë§‰ì•„ë‘ (ì™„ë²½í•œ ë¶€ì •ë°©ì§€ëŠ” ë¡œê·¸ì¸ í•„ìš”).
    </div>
  </div>

  <div class="grid" id="grid"></div>
  <div class="empty" id="empty" style="display:none;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ë°ì´(=ì—†ìŒ). í‚¤ì›Œë“œë‚˜ í•„í„°ë¥¼ ë°”ê¿”ë³´ì´ì†Œ.</div>
</main>

<!-- Detail Modal -->
<div class="backdrop" id="detailBackdrop" role="dialog" aria-modal="true">
  <div class="modal">
    <button class="close ghost" id="closeDetail">ë‹«ê¸°</button>
    <h2 id="mTitle">-</h2>
    <div class="meta" id="mMeta"></div>
    <p class="desc" id="mDesc"></p>

    <div class="kvs">
      <div><b>ì£¼ì†Œ</b><br><span id="mAddr">-</span></div>
      <div><b>ì¶”ì²œ ë©”ë‰´</b><br><span id="mMenu">-</span></div>
      <div><b>ê°€ê²©ëŒ€</b><br><span id="mPrice">-</span></div>
      <div><b>ì˜ì—…</b><br><span id="mHours">-</span></div>
    </div>

    <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap">
      <button class="good" id="likeThisMonth">â¤ï¸ ì¢‹ì•„ìš”</button>
      <button class="ghost" id="mapKakao">ì¹´ì¹´ì˜¤ ì§€ë„</button>
      <button class="ghost" id="mapNaver">ë„¤ì´ë²„ ì§€ë„</button>
      <button class="ghost" id="mapGoogle">êµ¬ê¸€ ì§€ë„</button>
      <button class="ghost" id="copy">ì •ë³´ ë³µì‚¬</button>
      <button class="warn" id="edit">ìˆ˜ì •</button>
      <button class="danger" id="del">ì‚­ì œ</button>
    </div>
  </div>
</div>

<!-- Add/Edit Modal -->
<div class="backdrop" id="formBackdrop" role="dialog" aria-modal="true">
  <div class="modal">
    <button class="close ghost" id="closeForm">ë‹«ê¸°</button>
    <h2 id="fTitle">ë§›ì§‘ ì¶”ê°€</h2>
    <div class="small">lat/lng ë„£ìœ¼ë©´ ê±°ë¦¬ ì •ë ¬ì´ ì°ìœ¼ë¡œ ë¨. ì—†ìœ¼ë©´ ì£¼ì†Œë§Œìœ¼ë¡œë„ OK.</div>

    <div class="hr"></div>

    <div class="grid2">
      <div class="formRow">
        <label>ê°€ê²Œëª… *</label>
        <input id="fName" placeholder="ì˜ˆ: ì—°ë‚¨ íŒŒìŠ¤íƒ€ ë°”" />
      </div>
      <div class="formRow">
        <label>ì¹´í…Œê³ ë¦¬ *</label>
        <select id="fCat">
          <option value="í•œì‹">í•œì‹</option>
          <option value="ì¼ì‹">ì¼ì‹</option>
          <option value="ì¤‘ì‹">ì¤‘ì‹</option>
          <option value="ì–‘ì‹">ì–‘ì‹</option>
          <option value="ì¹´í˜">ì¹´í˜</option>
          <option value="ìˆ ì§‘">ìˆ ì§‘</option>
          <option value="ê¸°íƒ€">ê¸°íƒ€</option>
        </select>
      </div>

      <div class="formRow">
        <label>íƒœê·¸ (ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
        <input id="fTags" placeholder="ì˜ˆ: ì„±ìˆ˜, í˜¼ë°¥, êµ­ë°¥" />
      </div>
      <div class="formRow">
        <label>í‰ì  (0~5)</label>
        <input id="fScore" type="number" min="0" max="5" step="0.1" placeholder="ì˜ˆ: 4.7" />
      </div>

      <div class="formRow">
        <label>ì£¼ì†Œ</label>
        <input id="fAddr" placeholder="ì˜ˆ: ì„œìš¸ ì„±ë™êµ¬ ..." />
      </div>
      <div class="formRow">
        <label>ì¶”ì²œ ë©”ë‰´</label>
        <input id="fMenu" placeholder="ì˜ˆ: ëˆì½”ì¸  ë¼ë©˜, ì°¨ìŠˆë®ë°¥" />
      </div>

      <div class="formRow">
        <label>ê°€ê²©ëŒ€</label>
        <input id="fPrice" placeholder="ì˜ˆ: â‚©â‚© (1~2ë§Œì›)" />
      </div>
      <div class="formRow">
        <label>ì˜ì—…ì‹œê°„</label>
        <input id="fHours" placeholder="ì˜ˆ: 11:00-21:00" />
      </div>

      <div class="formRow">
        <label>ì„¤ëª…(í•œì¤„/ë©”ëª¨)</label>
        <textarea id="fDesc" placeholder="ì˜ˆ: ë¶„ìœ„ê¸° good vibes(ê°ì„± ì¢‹ìŒ). ì¬ë°©ë¬¸ ì˜ì‚¬ 100%"></textarea>
      </div>
      <div class="formRow">
        <label>lat / lng (ì„ íƒ)</label>
        <div class="split">
          <input id="fLat" type="number" step="0.000001" placeholder="ìœ„ë„(lat) ì˜ˆ: 37.5665" />
          <input id="fLng" type="number" step="0.000001" placeholder="ê²½ë„(lng) ì˜ˆ: 126.9780" />
        </div>
        <div class="small">êµ¬ê¸€ì§€ë„ì—ì„œ ìš°í´ë¦­ â†’ ì¢Œí‘œ ë³µì‚¬í•´ì„œ ë¶™ì´ë©´ ë¨.</div>
      </div>
    </div>

    <div class="hr"></div>

    <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end">
      <button class="ghost" id="fCancel">ì·¨ì†Œ</button>
      <button class="primary" id="fSave">ì €ì¥</button>
    </div>
  </div>
</div>

<script>
/* ============================
const LIKE_API_URL = "https://script.google.com/macros/s/AKfycbzguY674lSLefGSKr0S0PkLyuQ9quEq1huyAWeVNAgBp5IuqMkfN9_KSnLD6q2DZXcH1w/exec";
   ============================ */
// TODO: ë„¤ Apps Script ì›¹ì•± URLë¡œ ë°”ê¿”ë¼!
const LIKE_API_URL = "https://script.google.com/macros/s/AKfycbzAYJrJ8j08iyR61S1W97E4yNI0dRUMKS8f6Bt1_EnZjRVG7om9LxEeyUODrqcXdv3PeA/exec";

/* ============================
   1) Storage keys / seed
   ============================ */
const LS_PLACES = "matzip_places_v3";
const LS_FAVS   = "matzip_favs_v3";
const LS_RECENT = "matzip_recent_v3";
const LS_LOC    = "matzip_my_loc_v1";

const seed = [
  {
    id:"s1",
    name:"ì„±ìˆ˜ êµ­ë°¥ì§‘",
    cat:"í•œì‹",
    tags:["ì„±ìˆ˜","í˜¼ë°¥","êµ­ë°¥"],
    score:4.6,
    desc:"í‡´ê·¼í•˜ê³  í•œ ê·¸ë¦‡ ë•Œë¦¬ê¸° ë”± ì¢‹ë‹¤ ì•„ì´ê°€(=ì¢‹ìŒ). êµ­ë¬¼ ê¹”ë”, íšŒì „ ë¹ ë¦„.",
    addr:"ì„œìš¸ ì„±ë™êµ¬ ì–´ë”˜ê°€ 123",
    menu:"ë¼ì§€êµ­ë°¥, ìˆ˜ìœ¡",
    price:"â‚©â‚© (1~2ë§Œì›)",
    hours:"11:00-21:00",
    lat:null, lng:null,
    addedAt: Date.now()- 1000*60*60*24*7
  },
  {
    id:"s2",
    name:"ì—°ë‚¨ íŒŒìŠ¤íƒ€ ë°”",
    cat:"ì–‘ì‹",
    tags:["ì—°ë‚¨","ë°ì´íŠ¸","íŒŒìŠ¤íƒ€"],
    score:4.4,
    desc:"ë¶„ìœ„ê¸° good vibes(ê°ì„± ì¢‹ìŒ). ë©´ ìµí˜ ì•ˆì •ì , ì™€ì¸ë„ ìˆìŒ.",
    addr:"ì„œìš¸ ë§ˆí¬êµ¬ ì–´ë”˜ê°€ 45",
    menu:"í¬ë¦¼íŒŒìŠ¤íƒ€, ë¼êµ¬",
    price:"â‚©â‚©â‚© (2~3ë§Œì›)",
    hours:"12:00-22:00",
    lat:null, lng:null,
    addedAt: Date.now()- 1000*60*60*24*4
  },
  {
    id:"s3",
    name:"ì„ì§€ë¡œ ë¼ë©˜",
    cat:"ì¼ì‹",
    tags:["ì„ì§€ë¡œ","ë¼ë©˜","ì›¨ì´íŒ…"],
    score:4.7,
    desc:"ì§„í•œ ëˆì½”ì¸ . ì›¨ì´íŒ… ìˆì„ ìˆ˜ ìˆìœ¼ë‹ˆ íƒ€ì´ë° ì˜ ë´ë¼ì‰(=ì˜í•´).",
    addr:"ì„œìš¸ ì¤‘êµ¬ ì–´ë”˜ê°€ 9",
    menu:"ëˆì½”ì¸  ë¼ë©˜, ì°¨ìŠˆë®ë°¥",
    price:"â‚©â‚© (1~2ë§Œì›)",
    hours:"11:30-20:30",
    lat:null, lng:null,
    addedAt: Date.now()- 1000*60*60*24*2
  }
];

/* ============================
   2) State
   ============================ */
let places = loadPlaces();
let favs   = loadSet(LS_FAVS);
let recent = loadArray(LS_RECENT);
let myLoc  = loadJSON(LS_LOC, null);

let selectedId = null;
let editingId  = null;

/* ============================
   3) Elements
   ============================ */
const grid = document.getElementById("grid");
const empty = document.getElementById("empty");
const countPill = document.getElementById("countPill");
const locPill = document.getElementById("locPill");

const q = document.getElementById("q");
const cat = document.getElementById("cat");
const sort = document.getElementById("sort");

const useLoc = document.getElementById("useLoc");
const addPlace = document.getElementById("addPlace");
const addDemo = document.getElementById("addDemo");
const reset = document.getElementById("reset");

// Monthly rank
const monthlyMonth = document.getElementById("monthlyMonth");
const monthlyList = document.getElementById("monthlyList");
const reloadRank = document.getElementById("reloadRank");

// Detail modal
const detailBackdrop = document.getElementById("detailBackdrop");
const closeDetail = document.getElementById("closeDetail");
const mTitle = document.getElementById("mTitle");
const mMeta  = document.getElementById("mMeta");
const mDesc  = document.getElementById("mDesc");
const mAddr  = document.getElementById("mAddr");
const mMenu  = document.getElementById("mMenu");
const mPrice = document.getElementById("mPrice");
const mHours = document.getElementById("mHours");
const likeThisMonth = document.getElementById("likeThisMonth");
const mapKakao = document.getElementById("mapKakao");
const mapNaver = document.getElementById("mapNaver");
const mapGoogle = document.getElementById("mapGoogle");
const copyBtn = document.getElementById("copy");
const editBtn = document.getElementById("edit");
const delBtn  = document.getElementById("del");

// Form modal
const formBackdrop = document.getElementById("formBackdrop");
const closeForm = document.getElementById("closeForm");
const fTitle = document.getElementById("fTitle");
const fName  = document.getElementById("fName");
const fCat   = document.getElementById("fCat");
const fTags  = document.getElementById("fTags");
const fScore = document.getElementById("fScore");
const fAddr  = document.getElementById("fAddr");
const fMenu  = document.getElementById("fMenu");
const fPrice = document.getElementById("fPrice");
const fHours = document.getElementById("fHours");
const fDesc  = document.getElementById("fDesc");
const fLat   = document.getElementById("fLat");
const fLng   = document.getElementById("fLng");
const fCancel= document.getElementById("fCancel");
const fSave  = document.getElementById("fSave");

/* ============================
   4) Events
   ============================ */
[q, cat, sort].forEach(el => el.addEventListener("input", render));

addDemo.addEventListener("click", () => {
  const ids = new Set(places.map(p=>p.id));
  let added = 0;
  seed.forEach(p=>{
    if(!ids.has(p.id)){ places.push(structPlace(p)); added++; }
  });
  if(added){ savePlaces(); render(); refreshMonthlyRanking(); }
  else alert("ë°ëª¨ëŠ” ì´ë¯¸ ë“¤ì–´ê°€ ìˆë°ì´(=ìˆìŒ).");
});

addPlace.addEventListener("click", () => openForm(null));

reset.addEventListener("click", () => {
  q.value=""; cat.value="all"; sort.value="reco";
  render();
});

reloadRank.addEventListener("click", refreshMonthlyRanking);

useLoc.addEventListener("click", async () => {
  if(!navigator.geolocation){ alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ê¸°ëŠ¥ì´ ì—†ë°ì´(=ì—†ìŒ)."); return; }
  useLoc.disabled = true;
  useLoc.textContent = "ğŸ“ ìœ„ì¹˜ ê°€ì ¸ì˜¤ëŠ” ì¤‘...";
  navigator.geolocation.getCurrentPosition(
    (pos)=>{
      myLoc = { lat: pos.coords.latitude, lng: pos.coords.longitude, ts: Date.now() };
      saveJSON(LS_LOC, myLoc);
      useLoc.disabled = false;
      useLoc.textContent = "ğŸ“ ë‚´ ìœ„ì¹˜ ì‚¬ìš©";
      updateLocPill();
      render();
    },
    ()=>{
      useLoc.disabled = false;
      useLoc.textContent = "ğŸ“ ë‚´ ìœ„ì¹˜ ì‚¬ìš©";
      alert("ìœ„ì¹˜ ê¶Œí•œì´ ë§‰í˜”ê±°ë‚˜ ì‹¤íŒ¨í–ˆë°ì´. ì£¼ì†Œì°½ ì˜† ğŸ”’ì—ì„œ ê¶Œí•œ í—ˆìš©í•´ë³´ì´ì†Œ.");
    },
    { enableHighAccuracy:true, timeout: 8000 }
  );
});

// Detail modal close
closeDetail.addEventListener("click", closeDetailModal);
detailBackdrop.addEventListener("click", (e)=>{ if(e.target===detailBackdrop) closeDetailModal(); });

// Form modal close
closeForm.addEventListener("click", closeFormModal);
fCancel.addEventListener("click", closeFormModal);
formBackdrop.addEventListener("click", (e)=>{ if(e.target===formBackdrop) closeFormModal(); });

// Save form
fSave.addEventListener("click", () => {
  const data = readForm();
  if(!data.name.trim()){ alert("ê°€ê²Œëª…ì€ í•„ìˆ˜ë‹¤ ì½”ë…¸ì•¼ë¡œ."); return; }

  if(editingId){
    const idx = places.findIndex(p=>p.id===editingId);
    if(idx>=0){
      places[idx] = { ...places[idx], ...data, updatedAt: Date.now() };
      savePlaces();
      closeFormModal();
      render();
      openDetail(editingId);
    }
  }else{
    const id = "p_" + Math.random().toString(36).slice(2,10);
    places.push(structPlace({ id, ...data, addedAt: Date.now() }));
    savePlaces();
    closeFormModal();
    render();
  }
});

// Delete
delBtn.addEventListener("click", () => {
  const p = getById(selectedId);
  if(!p) return;
  if(!confirm(`"${p.name}" ì§„ì§œ ì‚­ì œí• ë¼? (ë³µêµ¬ ì•ˆ ë¨)`)) return;
  places = places.filter(x=>x.id!==p.id);
  favs.delete(p.id);
  recent = recent.filter(id=>id!==p.id);
  savePlaces(); saveSet(LS_FAVS, favs); saveArray(LS_RECENT, recent);
  closeDetailModal();
  render();
  refreshMonthlyRanking();
});

// Edit
editBtn.addEventListener("click", () => {
  const p = getById(selectedId);
  if(!p) return;
  closeDetailModal(false);
  openForm(p);
});

// Copy
copyBtn.addEventListener("click", async () => {
  const p = getById(selectedId);
  if(!p) return;
  const text =
`[${p.name}]
ì¹´í…Œê³ ë¦¬: ${p.cat}
í‰ì : ${fmtScore(p.score)}
íƒœê·¸: ${(p.tags||[]).join(", ")}
ì£¼ì†Œ: ${p.addr||"-"}
ì¶”ì²œ ë©”ë‰´: ${p.menu||"-"}
ê°€ê²©ëŒ€: ${p.price||"-"}
ì˜ì—…: ${p.hours||"-"}
ì¢Œí‘œ: ${p.lat ?? "-"}, ${p.lng ?? "-"}`;
  try{ await navigator.clipboard.writeText(text); alert("ë³µì‚¬ ì™„ë£Œ!"); }
  catch{ alert("ë³µì‚¬ ì‹¤íŒ¨â€¦ ë¸Œë¼ìš°ì € ê¶Œí•œ í™•ì¸í•´ì£¼ì´ì†Œ."); }
});

// Maps
mapKakao.addEventListener("click", ()=>openMap("kakao"));
mapNaver.addEventListener("click", ()=>openMap("naver"));
mapGoogle.addEventListener("click", ()=>openMap("google"));

// Like (shared monthly)
likeThisMonth.addEventListener("click", likeMonthly);

/* ============================
   5) Init
   ============================ */
updateLocPill();
render();
refreshMonthlyRanking();

/* ============================
   6) Core functions
   ============================ */
function ymNow(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  return `${y}-${m}`;
}

function loadPlaces(){
  const raw = loadJSON(LS_PLACES, null);
  return raw && Array.isArray(raw) ? raw.map(structPlace) : [];
}
function savePlaces(){ saveJSON(LS_PLACES, places); }

function loadJSON(key, fallback){
  try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : fallback; }
  catch{ return fallback; }
}
function saveJSON(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

function loadSet(key){
  try{ const raw = localStorage.getItem(key); return raw ? new Set(JSON.parse(raw)) : new Set(); }
  catch{ return new Set(); }
}
function saveSet(key, set){ localStorage.setItem(key, JSON.stringify([...set])); }

function loadArray(key){
  try{ const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : []; }
  catch{ return []; }
}
function saveArray(key, arr){ localStorage.setItem(key, JSON.stringify(arr)); }

function numOrNull(v){
  if(v===null || v===undefined || v==="") return null;
  const n = Number(v);
  return Number.isFinite(n) ? n : null;
}
function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }

function structPlace(p){
  const tags = Array.isArray(p.tags) ? p.tags : (typeof p.tags==="string" ? p.tags.split(",").map(s=>s.trim()).filter(Boolean) : []);
  const score = numOrNull(p.score);
  const lat = numOrNull(p.lat);
  const lng = numOrNull(p.lng);
  return {
    id: p.id ?? ("p_" + Math.random().toString(36).slice(2,10)),
    name: String(p.name ?? "").trim(),
    cat: String(p.cat ?? "ê¸°íƒ€"),
    tags,
    score: (score==null ? 0 : clamp(score, 0, 5)),
    desc: String(p.desc ?? ""),
    addr: String(p.addr ?? ""),
    menu: String(p.menu ?? ""),
    price: String(p.price ?? ""),
    hours: String(p.hours ?? ""),
    lat, lng,
    addedAt: p.addedAt ?? Date.now(),
    updatedAt: p.updatedAt ?? null
  };
}

function fmtScore(s){
  const n = Number(s);
  if(!Number.isFinite(n)) return "-";
  return n.toFixed(1).replace(/\.0$/, "");
}

function updateLocPill(){
  if(myLoc && Number.isFinite(myLoc.lat) && Number.isFinite(myLoc.lng)){
    locPill.textContent = `ğŸ“ ìœ„ì¹˜: ON (${myLoc.lat.toFixed(3)}, ${myLoc.lng.toFixed(3)})`;
  }else{
    locPill.textContent = "ğŸ“ ìœ„ì¹˜: ë¯¸ì‚¬ìš©";
  }
}

function getById(id){ return places.find(p=>p.id===id); }

function distanceKm(aLat, aLng, bLat, bLng){
  const R = 6371;
  const toRad = (d)=>d*Math.PI/180;
  const dLat = toRad(bLat - aLat);
  const dLng = toRad(bLng - aLng);
  const sa = Math.sin(dLat/2)**2 +
    Math.cos(toRad(aLat))*Math.cos(toRad(bLat))*Math.sin(dLng/2)**2;
  const c = 2*Math.atan2(Math.sqrt(sa), Math.sqrt(1-sa));
  return R*c;
}

function calcRecoScore(p){
  let score = (p.score ?? 0) * 20;
  if(favs.has(p.id)) score += 12;
  const idx = recent.indexOf(p.id);
  if(idx >= 0) score += Math.max(0, 10 - idx*2);
  if(myLoc && p.lat!=null && p.lng!=null){
    const km = distanceKm(myLoc.lat, myLoc.lng, p.lat, p.lng);
    if(km <= 5) score += 12;
    else if(km <= 20) score += 6;
  }
  if((p.tags||[]).length >= 3) score += 2;
  return score;
}

function matchesFilters(p){
  const keyword = q.value.trim().toLowerCase();
  const inCat = (cat.value === "all") || (p.cat === cat.value);
  const inQ = !keyword || (
    (p.name||"").toLowerCase().includes(keyword) ||
    (p.addr||"").toLowerCase().includes(keyword) ||
    (p.tags||[]).some(t => (t||"").toLowerCase().includes(keyword))
  );
  return inCat && inQ;
}

function sortList(list){
  const v = sort.value;
  if(v === "name") return list.sort((a,b)=> (a.name||"").localeCompare(b.name||"", "ko"));
  if(v === "new")  return list.sort((a,b)=> (b.addedAt||0) - (a.addedAt||0));
  if(v === "score")return list.sort((a,b)=> (b.score||0) - (a.score||0));
  if(v === "near"){
    return list.sort((a,b)=>{
      const ak = (myLoc && a.lat!=null && a.lng!=null) ? distanceKm(myLoc.lat, myLoc.lng, a.lat, a.lng) : Infinity;
      const bk = (myLoc && b.lat!=null && b.lng!=null) ? distanceKm(myLoc.lat, myLoc.lng, b.lat, b.lng) : Infinity;
      return ak - bk;
    });
  }
  return list.sort((a,b)=> calcRecoScore(b) - calcRecoScore(a));
}

function render(){
  const list = sortList(places.filter(matchesFilters));
  countPill.textContent = `${list.length} places`;
  grid.innerHTML = "";
  empty.style.display = list.length ? "none" : "block";

  list.forEach(p=>{
    const card = document.createElement("div");
    card.className = "card";

    const top = document.createElement("div");
    top.className = "row";

    const left = document.createElement("div");
    left.style.minWidth = "0";

    const name = document.createElement("div");
    name.className = "name";
    name.textContent = p.name || "(ì´ë¦„ ì—†ìŒ)";

    const meta = document.createElement("div");
    meta.className = "meta";
    meta.append(tag(p.cat || "ê¸°íƒ€"));

    const tPreview = (p.tags||[]).slice(0,2).join(" Â· ");
    if(tPreview) meta.append(tag(tPreview));

    if(myLoc && p.lat!=null && p.lng!=null){
      const km = distanceKm(myLoc.lat, myLoc.lng, p.lat, p.lng);
      const kmTag = tag(`${km.toFixed(1)}km`);
      kmTag.classList.add("km");
      meta.append(kmTag);
    }

    meta.append(tag(`ì¶”ì²œ ${Math.round(calcRecoScore(p))}`));
    left.append(name, meta);

    const right = document.createElement("div");
    right.className = "score";
    right.innerHTML = `${fmtScore(p.score)} <small>/5</small>`;
    top.append(left, right);

    const desc = document.createElement("div");
    desc.className = "desc";
    desc.textContent = p.desc || "ë©”ëª¨ ì—†ìŒ. (ìƒì„¸ì—ì„œ ìˆ˜ì • ê°€ëŠ¥)";

    const btns = document.createElement("div");
    btns.className = "btns";

    const detail = document.createElement("button");
    detail.className = "primary";
    detail.textContent = "ìƒì„¸ë³´ê¸°";
    detail.addEventListener("click", ()=>openDetail(p.id));

    const fav = document.createElement("button");
    fav.className = "fav";
    if(favs.has(p.id)) fav.classList.add("on");
    fav.textContent = favs.has(p.id) ? "â˜… ì €ì¥ë¨" : "â˜† ì €ì¥";
    fav.addEventListener("click", ()=>{
      toggleFav(p.id);
    });

    btns.append(detail, fav);

    card.append(top, desc, btns);
    grid.appendChild(card);
  });
}

function tag(text){
  const span = document.createElement("span");
  span.className = "tag";
  span.textContent = text;
  return span;
}

function toggleFav(id){
  if(favs.has(id)) favs.delete(id);
  else favs.add(id);
  saveSet(LS_FAVS, favs);
  render();
}

function openDetail(id){
  const p = getById(id);
  if(!p) return;
  selectedId = id;

  recent = recent.filter(x=>x!==id);
  recent.unshift(id);
  recent = recent.slice(0, 20);
  saveArray(LS_RECENT, recent);

  mTitle.textContent = p.name;
  mDesc.textContent = p.desc || "";

  mMeta.innerHTML = "";
  const bits = [
    `ì¹´í…Œê³ ë¦¬: ${p.cat}`,
    `í‰ì : ${fmtScore(p.score)}`,
    `íƒœê·¸: ${(p.tags||[]).join(", ") || "-"}`
  ];
  if(myLoc && p.lat!=null && p.lng!=null){
    const km = distanceKm(myLoc.lat, myLoc.lng, p.lat, p.lng);
    bits.push(`ê±°ë¦¬: ${km.toFixed(2)} km`);
  }else{
    bits.push(`ê±°ë¦¬: (ì¢Œí‘œ/ìœ„ì¹˜ í•„ìš”)`);
  }
  bits.forEach(b=>{
    const span = document.createElement("span");
    span.className = "tag";
    span.textContent = b;
    mMeta.appendChild(span);
  });

  mAddr.textContent = p.addr || "-";
  mMenu.textContent = p.menu || "-";
  mPrice.textContent = p.price || "-";
  mHours.textContent = p.hours || "-";

  detailBackdrop.classList.add("show");
}

function closeDetailModal(clearSel=true){
  detailBackdrop.classList.remove("show");
  if(clearSel) selectedId = null;
}

function openMap(provider){
  const p = getById(selectedId);
  if(!p) return;
  const query = encodeURIComponent((p.name||"") + " " + (p.addr||""));
  if(provider==="google") return window.open(`https://www.google.com/maps/search/?api=1&query=${query}`, "_blank");
  if(provider==="naver")  return window.open(`https://map.naver.com/v5/search/${query}`, "_blank");
  return window.open(`https://map.kakao.com/?q=${query}`, "_blank");
}

function openForm(placeOrNull){
  editingId = placeOrNull?.id ?? null;
  fTitle.textContent = editingId ? "ë§›ì§‘ ìˆ˜ì •" : "ë§›ì§‘ ì¶”ê°€";

  fName.value = placeOrNull?.name ?? "";
  fCat.value  = placeOrNull?.cat ?? "ê¸°íƒ€";
  fTags.value = (placeOrNull?.tags ?? []).join(", ");
  fScore.value= placeOrNull?.score ?? "";
  fAddr.value = placeOrNull?.addr ?? "";
  fMenu.value = placeOrNull?.menu ?? "";
  fPrice.value= placeOrNull?.price ?? "";
  fHours.value= placeOrNull?.hours ?? "";
  fDesc.value = placeOrNull?.desc ?? "";
  fLat.value  = placeOrNull?.lat ?? "";
  fLng.value  = placeOrNull?.lng ?? "";

  formBackdrop.classList.add("show");
}

function closeFormModal(){
  formBackdrop.classList.remove("show");
  editingId = null;
}

function readForm(){
  return {
    name: (fName.value||"").trim(),
    cat:  fCat.value,
    tags: (fTags.value||"").split(",").map(s=>s.trim()).filter(Boolean),
    score: clamp(Number(fScore.value||0), 0, 5),
    addr: (fAddr.value||"").trim(),
    menu: (fMenu.value||"").trim(),
    price:(fPrice.value||"").trim(),
    hours:(fHours.value||"").trim(),
    desc: (fDesc.value||"").trim(),
    lat:  (fLat.value===""? null : Number(fLat.value)),
    lng:  (fLng.value===""? null : Number(fLng.value))
  };
}

/* ============================
   7) Monthly Like Ranking (shared)
   ============================ */
async function refreshMonthlyRanking(){
  const month = ymNow();
  monthlyMonth.textContent = `${month} ê¸°ì¤€ Â· ëª¨ë‘ì˜ ì¢‹ì•„ìš” í•©ì‚°`;
  if(!LIKE_API_URL || LIKE_API_URL.includes("PASTE_YOUR")){
    monthlyList.textContent = "âš ï¸ LIKE_API_URLì´ ë¹„ì–´ìˆìŒ. Apps Script ì›¹ì•± URL ë„£ì–´ì•¼ ë­í‚¹ ëœ¸.";
    return;
  }
  try{
    const url = `${LIKE_API_URL}?action=rank&month=${encodeURIComponent(month)}`;
    const res = await fetch(url);
    const data = await res.json();
    if(!data.ok) throw new Error(data.error || "rank failed");

    const top = (data.ranking || []).slice(0,10).map((r, i) => {
      const p = places.find(x=>x.id===r.placeId);
      const name = p ? p.name : `(ì—†ëŠ” ë§›ì§‘: ${r.placeId})`;
      return `${i+1}ìœ„ Â· ${name} â€” ${r.likes}â¤ï¸`;
    });

    monthlyList.textContent = top.length ? top.join("\n") : "ì•„ì§ ì¢‹ì•„ìš”ê°€ ì—†ë‹¤â€¦ 1ë“±ì€ ë‹ˆê°€ ë§Œë“ ë‹¤ ğŸ˜";
    monthlyList.style.whiteSpace = "pre-line";
  }catch(e){
    monthlyList.textContent = "ë­í‚¹ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨â€¦ (ì›¹ì•± URL/ë°°í¬ ê¶Œí•œ/ì‹œíŠ¸ íƒ­ ì´ë¦„) í™•ì¸";
    console.warn(e);
  }
}

async function likeMonthly(){
  // âœ… ì„ íƒëœ ë§›ì§‘ì´ ì—†ìœ¼ë©´ ë°”ë¡œ ì»·
  if(!selectedId){
    alert("ë¨¼ì € ë§›ì§‘ 'ìƒì„¸ë³´ê¸°'ë¥¼ ì—´ê³  â¤ï¸ë¥¼ ëˆŒëŸ¬ì•¼ í•œë‹¤ ì•„ì´ê°€.");
    return;
  }

  const p = places.find(x => x.id === selectedId);
  if(!p || !p.id){
    alert("placeIdë¥¼ ëª» ì°¾ì•˜ë‹¤â€¦ (ë°ì´í„° id í™•ì¸ í•„ìš”)");
    console.log("DEBUG selectedId=", selectedId, "place=", p);
    return;
  }

  if(!LIKE_API_URL || LIKE_API_URL.includes("PASTE_YOUR")){
    alert("LIKE_API_URLë¶€í„° ë„£ì–´ì•¼ í•¨! (Apps Script ì›¹ì•± URL)");
    return;
  }

  const month = ymNow();
  const key = `liked_${month}_${p.id}`;
  if(localStorage.getItem(key)){
    alert("ì´ë²ˆ ë‹¬ì— ì´ ê°€ê²ŒëŠ” ì´ë¯¸ ì¢‹ì•„ìš” í–ˆë‹¤ ì•„ì´ê°€ ğŸ˜…");
    return;
  }

  try{
    likeThisMonth.disabled = true;
    likeThisMonth.textContent = "â¤ï¸ ë°˜ì˜ì¤‘...";

    // âœ… í¼ ì „ì†¡ (placeId/month í™•ì‹¤íˆ ì „ë‹¬)
    const res = await fetch(LIKE_API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
      body: new URLSearchParams({ placeId: p.id, month })
    });

    const data = await res.json();
    if(!data.ok) throw new Error(data.error || "like failed");

    localStorage.setItem(key, "1");
    alert(`ì¢‹ì•„ìš” ì™„ë£Œ! í˜„ì¬ ${data.likes}â¤ï¸ (ì´ë²ˆ ë‹¬)`);

    await refreshMonthlyRanking();
  }catch(e){
    alert("ì¢‹ì•„ìš” ì‹¤íŒ¨â€¦ (ì›¹ì•± URL/ë°°í¬ ê¶Œí•œ/ì‹œíŠ¸ íƒ­ ì´ë¦„) í™•ì¸í•´ë³´ì´ì†Œ.");
    console.warn(e);
  }finally{
    likeThisMonth.disabled = false;
    likeThisMonth.textContent = "â¤ï¸ ì¢‹ì•„ìš”";
  }
}

</script>
</body>
</html>
