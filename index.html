<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Matzip Picks</title>
  <style>
    :root{
      --bg:#0b1020;
      --card:#121a33;
      --card2:#0f162d;
      --line:rgba(255,255,255,.10);
      --text:#eaf0ff;
      --muted:rgba(234,240,255,.72);
      --accent:#7dd3fc;
      --accent2:#a7f3d0;
      --danger:#fb7185;
      --shadow: 0 12px 40px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Apple SD Gothic Neo, Noto Sans KR, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(900px 450px at 20% 0%, rgba(125,211,252,.18), transparent 60%),
                  radial-gradient(900px 450px at 80% 0%, rgba(167,243,208,.14), transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .topbar{
      display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      margin-bottom:14px;
    }
    .brand{
      display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.2px;
    }
    .brand .logo{font-size:20px}
    .pill{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      border-radius:999px;
      padding:8px 10px;
      display:flex;gap:8px;align-items:center;
    }
    input, select, textarea, button{
      font:inherit;
      color:var(--text);
    }
    input, select, textarea{
      background:rgba(255,255,255,.04);
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      outline:none;
    }
    textarea{min-height:88px;resize:vertical}
    button{
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      transition:.15s transform, .15s background;
    }
    button:hover{background:rgba(255,255,255,.10)}
    button:active{transform:scale(.98)}
    .btn-primary{
      background:linear-gradient(135deg, rgba(125,211,252,.25), rgba(167,243,208,.18));
      border-color:rgba(125,211,252,.35);
    }
    .btn-danger{border-color:rgba(251,113,133,.35);background:rgba(251,113,133,.08)}
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
    }
    @media (max-width:960px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      display:flex;justify-content:space-between;align-items:center;
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      background:rgba(0,0,0,.12);
    }
    .card .bd{padding:14px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row > *{flex:1}
    .row .tight{flex:0 0 auto}
    .places{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:12px;
    }
    @media (max-width:960px){.places{grid-template-columns:repeat(2, minmax(0,1fr))}}
    @media (max-width:560px){.places{grid-template-columns:1fr}}
    .place{
      background:rgba(0,0,0,.18);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:14px;
      display:flex;flex-direction:column;gap:8px;
    }
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);color:var(--muted)}
    .title{font-weight:800;font-size:18px}
    .meta{display:flex;gap:8px;flex-wrap:wrap}
    .kv{display:flex;gap:6px;flex-wrap:wrap;color:var(--muted);font-size:13px}
    .actions{display:flex;gap:8px;margin-top:6px}
    .actions button{flex:1}
    .top10line{display:flex;justify-content:space-between;gap:12px;padding:9px 0;border-bottom:1px dashed rgba(255,255,255,.14)}
    .top10line:last-child{border-bottom:none}
    .top10left b{margin-right:6px}
    /* modal */
    .backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.55);
      display:none;align-items:center;justify-content:center;padding:18px;
    }
    .modal{
      width:min(760px, 100%);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .modal .hd{padding:14px 14px 10px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center}
    .modal .bd{padding:14px}
    .modal .ft{padding:14px;border-top:1px solid var(--line);display:flex;gap:10px}
    .kvs{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:640px){.kvs{grid-template-columns:1fr}}
    .kvbox{padding:10px 12px;border:1px solid var(--line);border-radius:14px;background:rgba(0,0,0,.18)}
    .kvbox .k{font-size:12px;color:var(--muted);margin-bottom:6px}
    .kvbox .v{font-weight:700}
    .small{font-size:12px;color:var(--muted)}
    .ok{color:var(--accent2)}
    .warn{color:var(--danger)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">ğŸœ</div>
        <div>
          <div style="font-size:18px;">Matzip Picks</div>
          <div class="small">ì´ë‹¬ì˜ ë§›ì§‘ TOP10(â¤ï¸ ì¢‹ì•„ìš” í•©ì‚°) Â· ê°œì¸ ì €ì¥ì€ ë¸Œë¼ìš°ì € ë¡œì»¬</div>
        </div>
      </div>
      <div class="row" style="justify-content:flex-end;gap:10px;flex:1">
        <div class="pill" style="min-width:260px;flex:1">
          ğŸ” <input id="q" placeholder="ê²€ìƒ‰: ìƒí˜¸/ì¹´í…Œê³ ë¦¬/íƒœê·¸ (ì˜ˆ: ì„±ìˆ˜, íŒŒìŠ¤íƒ€, í˜¼ë°¥)" style="border:none;background:transparent;padding:0;flex:1" />
        </div>
        <select id="cat" class="tight">
          <option value="">ì¹´í…Œê³ ë¦¬: ì „ì²´</option>
          <option>í•œì‹</option><option>ì¼ì‹</option><option>ì¤‘ì‹</option><option>ì–‘ì‹</option><option>ë¶„ì‹</option>
          <option>ì¹´í˜</option><option>ìˆ ì§‘</option><option>ë””ì €íŠ¸</option><option>ê¸°íƒ€</option>
        </select>
        <select id="sort" class="tight">
          <option value="rec">ì •ë ¬: ì¶”ì²œìˆœ</option>
          <option value="rate">ì •ë ¬: í‰ì ìˆœ</option>
          <option value="new">ì •ë ¬: ìµœì‹ ìˆœ</option>
        </select>
        <button id="openAdd" class="btn-primary tight">+ ë§›ì§‘ ì¶”ê°€</button>
        <button id="addDemo" class="tight">+ ë°ëª¨ 3ê°œ ì¶”ê°€</button>
        <button id="reset" class="btn-danger tight">ë¦¬ì…‹</button>
      </div>
    </div>

    <div class="grid">
      <!-- Left: list -->
      <div class="card">
        <div class="hd">
          <div><b>ğŸ½ï¸ ë§›ì§‘ ë¦¬ìŠ¤íŠ¸</b> <span class="muted" id="count"></span></div>
          <div class="small">â­ ì €ì¥ì€ ë‚´ ë¸Œë¼ìš°ì €ë§Œ. â¤ï¸ ì¢‹ì•„ìš”ëŠ” ëª¨ë‘ í•©ì‚°(êµ¬ê¸€ì‹œíŠ¸)</div>
        </div>
        <div class="bd">
          <div class="places" id="places"></div>
        </div>
      </div>

      <!-- Right: monthly top10 -->
      <div class="card">
        <div class="hd">
          <div>
            <b>ğŸ† ì´ë‹¬ì˜ ë§›ì§‘ TOP 10</b>
            <div class="small" id="topSubtitle"></div>
          </div>
          <button id="refreshTop" class="tight">ìƒˆë¡œê³ ì¹¨</button>
        </div>
        <div class="bd">
          <div id="topList"></div>
          <div class="small" style="margin-top:10px;">
            âœ… ì¢‹ì•„ìš”ëŠ” <b>ë¸Œë¼ìš°ì €ë‹¹ ì›” 1íšŒ/ê°€ê²Œ</b> ì •ë„ë§Œ ë§‰ì•„ë‘ (ì™„ì „ ë°©ì§€ëŠ” ë¡œê·¸ì¸ í•„ìš”).<br/>
            âœ… rankingì€ <b>êµ¬ê¸€ì‹œíŠ¸ì— ìŒ“ì¸ likes í•©ì‚°</b>ìœ¼ë¡œ ê³„ì‚°.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Detail modal -->
  <div class="backdrop" id="backdrop">
    <div class="modal">
      <div class="hd">
        <div>
          <div class="title" id="dName">-</div>
          <div class="small" id="dSub">-</div>
        </div>
        <button id="closeDetail" class="tight">ë‹«ê¸°</button>
      </div>
      <div class="bd">
        <div class="kvs">
          <div class="kvbox">
            <div class="k">ì¹´í…Œê³ ë¦¬</div>
            <div class="v" id="dCat">-</div>
          </div>
          <div class="kvbox">
            <div class="k">í‰ì </div>
            <div class="v" id="dRate">-</div>
          </div>
          <div class="kvbox">
            <div class="k">ì˜ì—…ì‹œê°„</div>
            <div class="v" id="dHours">-</div>
          </div>
          <div class="kvbox">
            <div class="k">ë¸Œë ˆì´í¬íƒ€ì„</div>
            <div class="v" id="dBreak">-</div>
          </div>
          <div class="kvbox">
            <div class="k">ì£¼ì†Œ/ìœ„ì¹˜ ë©”ëª¨</div>
            <div class="v" id="dAddr">-</div>
          </div>
          <div class="kvbox">
            <div class="k">íƒœê·¸</div>
            <div class="v" id="dTags">-</div>
          </div>
        </div>
        <div class="kvbox" style="margin-top:10px">
          <div class="k">í•œ ì¤„ ë¦¬ë·°</div>
          <div class="v" id="dNote" style="font-weight:600;line-height:1.5"></div>
        </div>
      </div>
      <div class="ft">
        <button id="toggleSave">â­ ì €ì¥</button>
        <button id="likeBtn" class="btn-primary">â¤ï¸ ì¢‹ì•„ìš”</button>
      </div>
    </div>
  </div>

  <!-- Add modal -->
  <div class="backdrop" id="addBackdrop">
    <div class="modal">
      <div class="hd">
        <div>
          <div class="title">+ ë§›ì§‘ ì¶”ê°€</div>
          <div class="small">ë¸Œë ˆì´í¬íƒ€ì„ë„ ì…ë ¥ ê°€ëŠ¥. (ì˜ˆ: 15:00~17:00 / ì—†ìŒ)</div>
        </div>
        <button id="closeAdd" class="tight">ë‹«ê¸°</button>
      </div>
      <div class="bd">
        <div class="row">
          <input id="aName" placeholder="ìƒí˜¸ëª… (í•„ìˆ˜)" />
          <select id="aCat" class="tight">
            <option value="">ì¹´í…Œê³ ë¦¬(í•„ìˆ˜)</option>
            <option>í•œì‹</option><option>ì¼ì‹</option><option>ì¤‘ì‹</option><option>ì–‘ì‹</option><option>ë¶„ì‹</option>
            <option>ì¹´í˜</option><option>ìˆ ì§‘</option><option>ë””ì €íŠ¸</option><option>ê¸°íƒ€</option>
          </select>
          <input id="aRate" class="tight" placeholder="í‰ì  (ì˜ˆ: 4.6)" />
        </div>
        <div class="row" style="margin-top:10px">
          <input id="aHours" placeholder="ì˜ì—…ì‹œê°„ (ì˜ˆ: 11:00~21:00 / ë§¤ì¼ 10~22)" />
          <input id="aBreak" placeholder="ë¸Œë ˆì´í¬íƒ€ì„ (ì˜ˆ: 15:00~17:00 / ì—†ìŒ)" />
        </div>
        <div class="row" style="margin-top:10px">
          <input id="aTags" placeholder="íƒœê·¸ (ì‰¼í‘œë¡œ êµ¬ë¶„: ì„±ìˆ˜,í˜¼ë°¥,ë°ì´íŠ¸)" />
          <input id="aAddr" placeholder="ì£¼ì†Œ/ìœ„ì¹˜ ë©”ëª¨ (ì„ íƒ)" />
        </div>
        <div style="margin-top:10px">
          <textarea id="aNote" placeholder="í•œ ì¤„ ë¦¬ë·°(í•„ìˆ˜) ì˜ˆ: êµ­ë¬¼ ê¹”ë”, íšŒì „ ë¹ ë¦„."></textarea>
        </div>
        <div class="small muted" style="margin-top:8px">
          * í˜„ì¬ëŠ” ë§›ì§‘ ë“±ë¡/ì €ì¥ì€ ë‚´ ë¸Œë¼ìš°ì €(localStorage).<br/>
          * â¤ï¸ ì¢‹ì•„ìš”ë§Œ êµ¬ê¸€ì‹œíŠ¸ë¡œ í•©ì‚°(ë‹¤ë¥¸ ì‚¬ëŒë“¤ê³¼ ê³µìœ ë˜ëŠ” ë­í‚¹).
        </div>
      </div>
      <div class="ft">
        <button id="addPlace" class="btn-primary">ì¶”ê°€</button>
      </div>
    </div>
  </div>

<script>
/* ============================
   0) ë„ˆê°€ ë°”ê¿€ ê±´ ì´ê²ƒ í•˜ë‚˜ë¿
   ============================ */
const LIKE_API_URL = "https://script.google.com/macros/s/AKfycbzguY674lSLefGSKr0S0PkLyuQ9quEq1huyAWeVNAgBp5IuqMkfN9_KSnLD6q2DZXcH1w/exec";

/* ============================
   1) State / Storage
   ============================ */
const LS_KEY = "matzip_picks_places_v1";
const LS_SAVED = "matzip_picks_saved_v1";

let places = loadPlaces_();
let savedMap = loadSaved_();     // {placeId:true}
let selectedId = null;

const $ = (id)=>document.getElementById(id);

function ymNow(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  return `${y}-${m}`;
}

function uid(){
  return "p_" + Math.random().toString(36).slice(2,9) + "_" + Date.now().toString(36);
}

function loadPlaces_(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(raw){
      const arr = JSON.parse(raw);
      if(Array.isArray(arr)) return arr;
    }
  }catch(e){}
  return [];
}

function savePlaces_(){
  localStorage.setItem(LS_KEY, JSON.stringify(places));
}

function loadSaved_(){
  try{
    const raw = localStorage.getItem(LS_SAVED);
    if(raw) return JSON.parse(raw) || {};
  }catch(e){}
  return {};
}

function saveSaved_(){
  localStorage.setItem(LS_SAVED, JSON.stringify(savedMap));
}

/* ============================
   2) Render
   ============================ */
function renderList(){
  const q = ($("q").value || "").trim().toLowerCase();
  const cat = $("cat").value;
  const sort = $("sort").value;

  let arr = [...places];

  if(cat){
    arr = arr.filter(p => (p.category || "") === cat);
  }
  if(q){
    arr = arr.filter(p => {
      const hay = [
        p.name, p.category, p.tags, p.note, p.address, p.hours, p.breakTime
      ].join(" ").toLowerCase();
      return hay.includes(q);
    });
  }

  if(sort === "rate"){
    arr.sort((a,b)=>(Number(b.rating||0) - Number(a.rating||0)));
  }else if(sort === "new"){
    arr.sort((a,b)=>(Number(b.createdAt||0)-Number(a.createdAt||0)));
  }else{
    // ì¶”ì²œìˆœ: ì €ì¥ëœ ê²ƒ ìš°ì„  + í‰ì 
    arr.sort((a,b)=>{
      const sa = savedMap[a.id] ? 1 : 0;
      const sb = savedMap[b.id] ? 1 : 0;
      if(sb !== sa) return sb - sa;
      return Number(b.rating||0) - Number(a.rating||0);
    });
  }

  $("count").textContent = `${arr.length} places`;

  const el = $("places");
  if(!arr.length){
    el.innerHTML = `<div class="muted">ì•„ì§ ë“±ë¡ëœ ë§›ì§‘ì´ ì—†ë‹¤â€¦ + ë§›ì§‘ ì¶”ê°€ë‚˜ ë°ëª¨ ë„£ì–´ë³´ìì‰ ğŸ˜</div>`;
    return;
  }

  el.innerHTML = arr.map(p => {
    const isSaved = !!savedMap[p.id];
    const tags = (p.tags||"").split(",").map(s=>s.trim()).filter(Boolean).slice(0,3);
    return `
      <div class="place">
        <div class="meta">
          <span class="badge">${escapeHtml(p.category||"ê¸°íƒ€")}</span>
          ${isSaved ? `<span class="badge" style="border-color:rgba(167,243,208,.35);color:var(--accent2)">â­ ì €ì¥ë¨</span>` : ``}
        </div>
        <div class="title">${escapeHtml(p.name)}</div>
        <div class="kv">
          <span>í‰ì : <b>${escapeHtml(String(p.rating ?? "-"))}</b></span>
          ${p.hours ? `<span>Â· ì˜ì—…: ${escapeHtml(p.hours)}</span>` : ``}
        </div>
        ${p.breakTime ? `<div class="kv">ë¸Œë ˆì´í¬: ${escapeHtml(p.breakTime)}</div>` : ``}
        <div class="kv">${tags.map(t=>`#${escapeHtml(t)}`).join(" ")}</div>
        <div class="muted" style="font-size:13px;line-height:1.45">${escapeHtml(p.note||"")}</div>
        <div class="actions">
          <button onclick="openDetail('${p.id}')">ìƒì„¸ë³´ê¸°</button>
          <button onclick="toggleSave('${p.id}')" class="${isSaved ? 'btn-primary':''}">${isSaved?'â­ ì €ì¥ë¨':'â­ ì €ì¥'}</button>
        </div>
      </div>
    `;
  }).join("");
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}

/* ============================
   3) Detail modal
   ============================ */
window.openDetail = function(id){
  selectedId = id;
  const p = places.find(x=>x.id===id);
  if(!p) return;

  $("dName").textContent = p.name || "-";
  $("dSub").textContent  = `${p.category || "ê¸°íƒ€"} Â· ${p.address ? p.address : "ì£¼ì†Œ/ìœ„ì¹˜: ë¯¸ìƒ"}`;
  $("dCat").textContent  = p.category || "-";
  $("dRate").textContent = (p.rating ?? "-");
  $("dHours").textContent= p.hours || "ë¯¸ê¸°ì…";
  $("dBreak").textContent= p.breakTime || "ì—†ìŒ/ë¯¸ê¸°ì…";
  $("dAddr").textContent = p.address || "ë¯¸ê¸°ì…";
  $("dTags").textContent = (p.tags || "ì—†ìŒ").split(",").map(s=>s.trim()).filter(Boolean).map(t=>`#${t}`).join(" ") || "ì—†ìŒ";
  $("dNote").textContent = p.note || "-";

  const isSaved = !!savedMap[p.id];
  $("toggleSave").textContent = isSaved ? "â­ ì €ì¥ë¨" : "â­ ì €ì¥";

  $("backdrop").style.display = "flex";
}

function closeDetail(){
  $("backdrop").style.display = "none";
}

/* ============================
   4) Save toggle
   ============================ */
window.toggleSave = function(id){
  savedMap[id] = !savedMap[id];
  if(!savedMap[id]) delete savedMap[id];
  saveSaved_();
  renderList();
  if(selectedId === id){
    $("toggleSave").textContent = savedMap[id] ? "â­ ì €ì¥ë¨" : "â­ ì €ì¥";
  }
}

/* ============================
   5) Likes (monthly, shared via Apps Script)
   ============================ */
async function likeMonthly(){
  if(!selectedId){
    alert("ë¨¼ì € ë§›ì§‘ ìƒì„¸ë³´ê¸° ì—´ê³  â¤ï¸ ëˆŒëŸ¬ë¼ì‰.");
    return;
  }
  const p = places.find(x=>x.id===selectedId);
  if(!p || !p.id){
    alert("placeIdë¥¼ ëª» ì°¾ì•˜ë‹¤â€¦ (ë°ì´í„° id í™•ì¸ í•„ìš”)");
    return;
  }
  if(!LIKE_API_URL || LIKE_API_URL.includes("PASTE_YOUR")){
    alert("LIKE_API_URLë¶€í„° ë„£ì–´ì•¼ í•¨! (Apps Script ì›¹ì•± URL)");
    return;
  }

  const month = ymNow();
  const key = `liked_${month}_${p.id}`;
  if(localStorage.getItem(key)){
    alert("ì´ë²ˆ ë‹¬ì— ì´ ê°€ê²ŒëŠ” ì´ë¯¸ ì¢‹ì•„ìš” í–ˆë‹¤ ì•„ì´ê°€ ğŸ˜…");
    return;
  }

  try{
    $("likeBtn").disabled = true;
    $("likeBtn").textContent = "â¤ï¸ ë°˜ì˜ì¤‘...";

    // âœ… form-urlencodedë¡œ ë³´ë‚´ì„œ CORS/í”„ë¦¬í”Œë¼ì´íŠ¸ ì´ìŠˆ ìµœì†Œí™”
    const res = await fetch(LIKE_API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
      body: new URLSearchParams({ placeId: p.id, month })
    });

    const data = await res.json();
    if(!data.ok) throw new Error(data.error || "like failed");

    localStorage.setItem(key, "1");
    alert(`ì¢‹ì•„ìš” ì™„ë£Œ! í˜„ì¬ ${data.likes}â¤ï¸ (ì´ë²ˆ ë‹¬)`);

    await refreshMonthlyRanking();
  }catch(e){
    console.warn(e);
    alert("ì¢‹ì•„ìš” ì‹¤íŒ¨â€¦ (ë°°í¬/ê¶Œí•œ/URL/ì‹œíŠ¸ íƒ­) ë‹¤ì‹œ í™•ì¸í•´ë³´ì´ì†Œ.");
  }finally{
    $("likeBtn").disabled = false;
    $("likeBtn").textContent = "â¤ï¸ ì¢‹ì•„ìš”";
  }
}

async function refreshMonthlyRanking(){
  const month = ymNow();
  $("topSubtitle").textContent = `${month} ê¸°ì¤€ Â· ëª¨ë‘ì˜ ì¢‹ì•„ìš” í•©ì‚°`;

  if(!LIKE_API_URL){
    $("topList").innerHTML = `<div class="muted">LIKE_API_URLì´ ë¹„ì–´ìˆë‹¤â€¦</div>`;
    return;
  }

  try{
    const url = `${LIKE_API_URL}?action=rank&month=${encodeURIComponent(month)}`;
    const res = await fetch(url);
    const data = await res.json();
    const ranking = data.ranking || [];

    if(!ranking.length){
      $("topList").innerHTML = `
        <div class="muted">ì•„ì§ ì¢‹ì•„ìš”ê°€ ì—†ë‹¤â€¦ 1ë“±ì€ ë‹ˆê°€ ë§Œë“ ë‹¤ ğŸ˜</div>
        <div class="small muted" style="margin-top:8px;">(ì¢‹ì•„ìš” ëˆ„ë¥´ë©´ ì—¬ê¸° ìˆœìœ„ë¡œ ëœ¸)</div>
      `;
      return;
    }

    $("topList").innerHTML = ranking.slice(0,10).map((r,i)=>{
      const p = places.find(x=>x.id===r.placeId);
      const name = p ? p.name : `(ì—†ëŠ” ë§›ì§‘: ${r.placeId})`;
      const likes = r.likes ?? 0;
      return `
        <div class="top10line">
          <div class="top10left"><b>${i+1}ìœ„</b> ${escapeHtml(name)}</div>
          <div class="top10right"><b>${likes}</b>â¤ï¸</div>
        </div>
      `;
    }).join("");
  }catch(err){
    console.warn(err);
    $("topList").innerHTML = `<div class="muted">ë­í‚¹ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨â€¦ ì½˜ì†”(F12) í™•ì¸í•´ë³´ì´ì†Œ.</div>`;
  }
}

/* ============================
   6) Add Place (with Break Time)
   ============================ */
function openAdd(){
  $("addBackdrop").style.display = "flex";
}
function closeAdd(){
  $("addBackdrop").style.display = "none";
}
function addPlace(){
  const name = $("aName").value.trim();
  const category = $("aCat").value.trim();
  const ratingRaw = $("aRate").value.trim();
  const hours = $("aHours").value.trim();
  const breakTime = $("aBreak").value.trim();
  const tags = $("aTags").value.trim();
  const address = $("aAddr").value.trim();
  const note = $("aNote").value.trim();

  if(!name){ alert("ìƒí˜¸ëª…ì€ í•„ìˆ˜ë‹¤ ì•„ì´ê°€."); return; }
  if(!category){ alert("ì¹´í…Œê³ ë¦¬ëŠ” í•„ìˆ˜ë‹¤ ì•„ì´ê°€."); return; }
  if(!note){ alert("í•œ ì¤„ ë¦¬ë·°ëŠ” í•„ìˆ˜ë‹¤ ì•„ì´ê°€."); return; }

  const rating = ratingRaw ? Number(ratingRaw) : null;
  const p = {
    id: uid(),
    name,
    category,
    rating: (Number.isFinite(rating) ? Math.round(rating*10)/10 : null),
    hours: hours || "",
    breakTime: breakTime || "",
    tags: tags || "",
    address: address || "",
    note,
    createdAt: Date.now()
  };

  places.unshift(p);
  savePlaces_();
  closeAdd();
  clearAddForm_();
  renderList();
  refreshMonthlyRanking(); // ì‹ ê·œ placeIdê°€ ìƒê²¼ìœ¼ë‹ˆ, "ì—†ëŠ” ë§›ì§‘" ë°©ì§€ìš©ìœ¼ë¡œ ê°±ì‹ 
}

function clearAddForm_(){
  $("aName").value="";
  $("aCat").value="";
  $("aRate").value="";
  $("aHours").value="";
  $("aBreak").value="";
  $("aTags").value="";
  $("aAddr").value="";
  $("aNote").value="";
}

/* ============================
   7) Demo / Reset
   ============================ */
function addDemo(){
  const now = Date.now();
  const demo = [
    {
      id:"s1",
      name:"ì„±ìˆ˜ êµ­ë°¥ì§‘",
      category:"í•œì‹",
      rating:4.6,
      hours:"11:00~21:00",
      breakTime:"15:00~17:00",
      tags:"ì„±ìˆ˜,í˜¼ë°¥,êµ­ë°¥",
      address:"ì„±ìˆ˜ë™(êµ¬ê¸€ì‹œíŠ¸/ë©”ëª¨)",
      note:"í‡´ê·¼í•˜ê³  í•œ ê·¸ë¦‡ ë•Œë¦¬ê¸° ë”± ì¢‹ë‹¤ ì•„ì´ê°€(=ì¢‹ìŒ). êµ­ë¬¼ ê¹”ë”, íšŒì „ ë¹ ë¦„.",
      createdAt: now-30000
    },
    {
      id:"s2",
      name:"ì„ì§€ë¡œ ë¼ë©˜",
      category:"ì¼ì‹",
      rating:4.7,
      hours:"12:00~22:00",
      breakTime:"ì—†ìŒ",
      tags:"ì„ì§€ë¡œ,ë¼ë©˜",
      address:"",
      note:"ì§„í•œ ëˆì½”ì¸ . ì›¨ì´íŒ… ìˆì„ ìˆ˜ ìˆìœ¼ë‹ˆ íƒ€ì´ë° ì˜ ë´ë¼ì‰(=ì¡°ì ˆí•´).",
      createdAt: now-20000
    },
    {
      id:"s3",
      name:"ì—°ë‚¨ íŒŒìŠ¤íƒ€ ë°”",
      category:"ì–‘ì‹",
      rating:4.4,
      hours:"11:30~21:30",
      breakTime:"15:30~17:00",
      tags:"ì—°ë‚¨,ë°ì´íŠ¸",
      address:"",
      note:"ë¶„ìœ„ê¸° good vibes(ê°ì„± ì¢‹ìŒ). ë©´ ìµí˜ ì•ˆì •ì , ì™€ì¸ë„ ìˆìŒ.",
      createdAt: now-10000
    }
  ];

  // ê¸°ì¡´ ë™ì¼ id ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸, ì—†ìœ¼ë©´ ì¶”ê°€
  for(const d of demo){
    const idx = places.findIndex(x=>x.id===d.id);
    if(idx>=0) places[idx] = {...places[idx], ...d};
    else places.push(d);
  }
  savePlaces_();
  renderList();
  refreshMonthlyRanking();
}

function resetAll(){
  if(!confirm("ì§„ì§œ ë¦¬ì…‹í• ê±°ê°€? (ë§›ì§‘/ì €ì¥/ì¢‹ì•„ìš” ë¡œì»¬ ê¸°ë¡ ë‹¤ ë‚ ì•„ê°)")) return;
  localStorage.removeItem(LS_KEY);
  localStorage.removeItem(LS_SAVED);

  // ì¢‹ì•„ìš” ë¡œì»¬í‚¤ë„ ê°™ì´ ì§€ìš°ê¸°(ì´ë²ˆë‹¬/ê°€ê²Œë³„)
  const month = ymNow();
  Object.keys(localStorage).forEach(k=>{
    if(k.startsWith(`liked_${month}_`)) localStorage.removeItem(k);
  });

  places = [];
  savedMap = {};
  selectedId = null;
  renderList();
  refreshMonthlyRanking();
}

/* ============================
   8) Wire up
   ============================ */
$("q").addEventListener("input", renderList);
$("cat").addEventListener("change", renderList);
$("sort").addEventListener("change", renderList);

$("openAdd").addEventListener("click", openAdd);
$("closeAdd").addEventListener("click", closeAdd);
$("addPlace").addEventListener("click", addPlace);

$("addDemo").addEventListener("click", addDemo);
$("reset").addEventListener("click", resetAll);

$("closeDetail").addEventListener("click", closeDetail);
$("backdrop").addEventListener("click", (e)=>{ if(e.target.id==="backdrop") closeDetail(); });

$("toggleSave").addEventListener("click", ()=>toggleSave(selectedId));
$("likeBtn").addEventListener("click", likeMonthly);

$("refreshTop").addEventListener("click", refreshMonthlyRanking);

// ì´ˆê¸° ë Œë”
renderList();
refreshMonthlyRanking();
</script>
</body>
</html>
